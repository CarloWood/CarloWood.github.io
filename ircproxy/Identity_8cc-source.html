<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML LANG="en-us">
 
<HEAD>
<META name="Author" content="Carlo Wood">
<META name="description" content="IRC proxy">
<META name="keywords" content="IRC, proxy, bnc, security, protection">
<META http-equiv="content-type" content="text/html; charset=iso-8859-1">
<TITLE>ircproxy documentation</TITLE>
<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
<LINK HREF="main.css" REL="stylesheet" TYPE="text/css">
</HEAD>

<BODY>

<TABLE class="header" BORDER=0 CELLSPACING=0 CELLPADDING=0>
<TR>
<TD WIDTH=120><IMG SRC="images/ircproxy.png" BORDER=0></TD>
<TD VALIGN=center ALIGN=center BGCOLOR="#0A0607"><FONT size=+4 color="#ffffff"><B>&nbsp;ircproxy</B>&nbsp;</FONT>
<FONT size=+3 color="#ffffff">The&nbsp;Ultimate&nbsp;Cyborg</FONT></TD>
</TR>
</TABLE>

<DIV class="normal">
<hr>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>Identity.cc</h1><a href="Identity_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// ircproxy -- An IRC bouncer.</span>
<a name="l00002"></a>00002 <span class="comment">//</span><span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">//! @file Identity.cc</span>
<a name="l00004"></a>00004 <span class="comment">//! @brief This file contains the implementation of class Identity.</span>
<a name="l00005"></a>00005 <span class="comment"></span><span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright (C) 2005 - 2007 by</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// Carlo Wood, Run on IRC &lt;carlo@alinoe.com&gt;</span>
<a name="l00009"></a>00009 <span class="comment">// RSA-1024 0x624ACAD5 1997-01-26                    Sign &amp; Encrypt</span>
<a name="l00010"></a>00010 <span class="comment">// Fingerprint16 = 32 EC A7 B6 AC DB 65 A6  F6 F6 55 DD 1C DC FF 61</span>
<a name="l00011"></a>00011 <span class="comment">//</span>
<a name="l00012"></a>00012 <span class="comment">// This file may be distributed under the terms of the Q Public License</span>
<a name="l00013"></a>00013 <span class="comment">// version 1.0 as appearing in the file LICENSE.QPL included in the</span>
<a name="l00014"></a>00014 <span class="comment">// packaging of this file.</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#ifndef USE_PCH</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#include "sys.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="debug_8h.html" title="This file contains the declaration of debug related macros, objects and functions...">debug.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#endif</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="MessageIn_8h.html" title="Header of class MessageIn.">MessageIn.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="Authentication_8h.html" title="This file contains the declaration of class Authentication.">Authentication.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="NoticeTarget_8h.html" title="This file contains the declaration of class NoticeTarget.">NoticeTarget.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "keys.h"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="Identity_8inl.html" title="This file contains the implementation of class Identity.">Identity.inl</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="Channel_8h.html" title="This file contains the declaration of class Channel.">Channel.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="Nick_8h.html" title="This file contains the declaration of class Nick.">Nick.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="PersistXML_8h.html" title="This file contains the declaration of class PersistXML.">PersistXML.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="is__channel_8h.html" title="This file contains the definition of the is_channel functions.">is_channel.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="ClientSession_8h.html" title="This file contains the declaration of class ClientSession.">ClientSession.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="Matcher_8h.html" title="This file contains the declaration of the Matcher classes.">Matcher.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="Application_8h.html" title="This file contains the declaration of class Application.">Application.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="WhoRequest_8h.html" title="Header of class WhoRequest.">WhoRequest.h</a>"</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment">//! @brief Write MessageIn \a msg to the ostream \a os.</span>
<a name="l00037"></a>00037 <span class="comment"></span><span class="comment">//</span>
<a name="l00038"></a>00038 <span class="comment">// This function was added temporarily as a kludge.</span>
<a name="l00039"></a>00039 <span class="comment">// It's use should probably eventually be replaced by MessageOut.</span>
<a name="l00040"></a><a class="code" href="classIdentity.html#332b96a519b9fc1475904db577f3c280">00040</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#332b96a519b9fc1475904db577f3c280" title="Write MessageIn msg to the ostream os.">Identity::pass_as_is_to</a>(<a class="code" href="classMessageIn.html" title="An IRC message as received from client or server.">MessageIn</a> <span class="keyword">const</span>&amp; msg, std::ostream&amp; os)
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042   <span class="keywordflow">if</span> (msg.<a class="code" href="classMessageIn.html#6b52008fa0571869419878e5661832b0" title="Returns true if there is a prefix.">has_prefix</a>())
<a name="l00043"></a>00043     os &lt;&lt; <span class="charliteral">':'</span> &lt;&lt; msg.<a class="code" href="classMessageIn.html#a510bc2b8615c95997f60ba79c220d36" title="The prefix.">prefix_str</a>() &lt;&lt; <span class="charliteral">' '</span>;
<a name="l00044"></a>00044   <span class="keywordflow">if</span> (msg.<a class="code" href="classMessageIn.html#d5b8161ee7bb2fa3e275ceb132d7f141" title="Returns true when this message is a numeric reply.">is_numeric</a>())
<a name="l00045"></a>00045     os &lt;&lt; msg.<a class="code" href="classMessageIn.html#a77dca3b67c97ce535900c747d5631f2" title="The numeric value of this numeric reply.">numeric</a>();
<a name="l00046"></a>00046   <span class="keywordflow">else</span>
<a name="l00047"></a>00047     os &lt;&lt; msg.<a class="code" href="classMessageIn.html#cc4398d6895d57fb2040a99394c6a1a0" title="The command as uppercase C string.">uppercase_command</a>();
<a name="l00048"></a>00048   <span class="keywordtype">int</span> number_of_parameters = msg.<a class="code" href="classMessageIn.html#cc92a979360c4c920199ca8d1f4fd0ba" title="The number of parameters.">params_size</a>();
<a name="l00049"></a>00049   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> param = 0; param &lt; number_of_parameters; ++param)
<a name="l00050"></a>00050   {
<a name="l00051"></a>00051     os &lt;&lt; <span class="charliteral">' '</span>;
<a name="l00052"></a>00052     <span class="keywordflow">if</span> (param == number_of_parameters - 1)
<a name="l00053"></a>00053       os &lt;&lt; <span class="charliteral">':'</span>;
<a name="l00054"></a>00054     os &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(param);
<a name="l00055"></a>00055   }
<a name="l00056"></a>00056   os &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 <span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment">//! @brief Write ClientMessageIn \a msg to the server.</span>
<a name="l00060"></a>00060 <span class="comment"></span><span class="comment">//</span>
<a name="l00061"></a>00061 <span class="comment">// This function was added temporarily as a kludge.</span>
<a name="l00062"></a>00062 <span class="comment">// It's use should probably eventually be replaced by MessageOut.</span>
<a name="l00063"></a><a class="code" href="classIdentity.html#6322ad040f46c004b07acedc6a4d8e89">00063</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#6322ad040f46c004b07acedc6a4d8e89" title="Write ClientMessageIn msg to the server.">Identity::pass_as_is_to_server</a>(<a class="code" href="classClientMessageIn.html" title="An IRC message as received from a client.">ClientMessageIn</a> <span class="keyword">const</span>&amp; msg)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065   <span class="keywordtype">bool</span> blocked = <span class="keyword">true</span>;
<a name="l00066"></a>00066   <span class="keywordflow">switch</span> (msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>())
<a name="l00067"></a>00067   {
<a name="l00068"></a>00068     <span class="keyword">using namespace </span>keys;
<a name="l00069"></a>00069     <span class="keywordflow">case</span> WHO:                   <span class="comment">// Query</span>
<a name="l00070"></a>00070     <span class="keywordflow">case</span> WHOIS:                 <span class="comment">// Query</span>
<a name="l00071"></a>00071     <span class="keywordflow">case</span> WHOWAS:                <span class="comment">// Query</span>
<a name="l00072"></a>00072       blocked = <span class="keyword">false</span>;
<a name="l00073"></a>00073       <span class="keywordflow">break</span>;
<a name="l00074"></a>00074     <span class="keywordflow">default</span>:
<a name="l00075"></a>00075       <span class="keywordflow">break</span>;
<a name="l00076"></a>00076   }
<a name="l00077"></a>00077   <span class="keywordflow">if</span> (blocked &amp;&amp; <a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().<a class="code" href="classServerConnection.html#46893748168791f5ec68caca30b07af1" title="Return the state of the connection.">state</a>() &lt; <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef23fcdc806883284d1121056468515dc4d" title="NICK with real nick name sent.">real_nick_sent</a>)
<a name="l00078"></a>00078     <a class="code" href="exceptions_8h.html#038a5f95e87598cdf451fa27eca0601c" title="Throw an exception.">THROW_EXCEPTION</a>(<a class="code" href="classFatalError.html" title="An exception class.">FatalError</a>(<span class="stringliteral">"Message to be passed as-is is blocked!"</span>),
<a name="l00079"></a>00079         <span class="stringliteral">"Identity::pass_as_is_to_server("</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">") called while server connection in state "</span> &lt;&lt; <a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().<a class="code" href="classServerConnection.html#46893748168791f5ec68caca30b07af1" title="Return the state of the connection.">state</a>() &lt;&lt; <span class="charliteral">'!'</span>);
<a name="l00080"></a>00080   <a class="code" href="classIdentity.html#332b96a519b9fc1475904db577f3c280" title="Write MessageIn msg to the ostream os.">pass_as_is_to</a>(msg, <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>());
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 <span class="comment"></span>
<a name="l00083"></a>00083 <span class="comment">//! @brief Write ServerMessageIn \a msg to the client.</span>
<a name="l00084"></a>00084 <span class="comment"></span><span class="comment">//</span>
<a name="l00085"></a>00085 <span class="comment">// This function was added temporarily as a kludge.</span>
<a name="l00086"></a>00086 <span class="comment">// It's use should probably eventually be replaced by MessageOut.</span>
<a name="l00087"></a><a class="code" href="classIdentity.html#5b6ed690dca4101538b7b8e03b3fb3c7">00087</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#5b6ed690dca4101538b7b8e03b3fb3c7" title="Write ServerMessageIn msg to the client.">Identity::pass_as_is_to_client</a>(<a class="code" href="classServerMessageIn.html" title="An IRC message as received from a server.">ServerMessageIn</a> <span class="keyword">const</span>&amp; msg)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089   <a class="code" href="classIdentity.html#332b96a519b9fc1475904db577f3c280" title="Write MessageIn msg to the ostream os.">pass_as_is_to</a>(msg, <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>());
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="classIdentity.html#3c41a896404c73d7f84a53e0a430c0c1">00092</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#3c41a896404c73d7f84a53e0a430c0c1" title="Called when a new message was received from the associated client.">Identity::new_client_message_received</a>(<a class="code" href="classClientMessageIn.html" title="An IRC message as received from a client.">ClientMessageIn</a> <span class="keyword">const</span>&amp; msg)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"Identity::new_client_message_received("</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="keywordflow">switch</span> (msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>())
<a name="l00097"></a>00097   {
<a name="l00098"></a>00098     <span class="keyword">using namespace </span>keys;
<a name="l00099"></a>00099     <span class="keywordflow">case</span> PASS:                  <span class="comment">// No target</span>
<a name="l00100"></a>00100       <a class="code" href="classAuthentication.html#45257d4b9eece61d7b96fd918379f036">Authentication::get</a>(<span class="keyword">this</span>, <a class="code" href="classIdentity.html#9d54312b39f830b32eee7b9bbe519695" title="Temporary authentication token, or NULL.">M_authentication</a>);
<a name="l00101"></a>00101       <a class="code" href="classIdentity.html#9d54312b39f830b32eee7b9bbe519695" title="Temporary authentication token, or NULL.">M_authentication</a>-&gt;decode_pass(msg);
<a name="l00102"></a>00102       <span class="keywordflow">break</span>;
<a name="l00103"></a>00103     <span class="keywordflow">case</span> USER:                  <span class="comment">// No target</span>
<a name="l00104"></a>00104       <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#0bfddc02b548d71e42a073e265e26221" title="A best-guess for this users ident.">M_ident</a> == unknown_ident)     <span class="comment">// It might be retrieved already from identd.</span>
<a name="l00105"></a>00105         <a class="code" href="classIdentity.html#0bfddc02b548d71e42a073e265e26221" title="A best-guess for this users ident.">M_ident</a> = msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0);
<a name="l00106"></a>00106       <a class="code" href="classIdentity.html#737a886f8703407d1344fc4c62d7aff2" title="A best-guess for this users real name.">M_real_name</a> = msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(3);
<a name="l00107"></a>00107       <a class="code" href="classAuthentication.html#45257d4b9eece61d7b96fd918379f036">Authentication::get</a>(<span class="keyword">this</span>, <a class="code" href="classIdentity.html#9d54312b39f830b32eee7b9bbe519695" title="Temporary authentication token, or NULL.">M_authentication</a>);
<a name="l00108"></a>00108       <a class="code" href="classIdentity.html#9d54312b39f830b32eee7b9bbe519695" title="Temporary authentication token, or NULL.">M_authentication</a>-&gt;decode_user(msg);
<a name="l00109"></a>00109       <span class="keywordflow">break</span>;
<a name="l00110"></a>00110     <span class="keywordflow">case</span> PING:                  <span class="comment">// No target</span>
<a name="l00111"></a>00111     {
<a name="l00112"></a>00112       std::string server_name(<a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().has_server() ? <a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().server()-&gt;get_irc_name() : <span class="stringliteral">"noserver.pong.org"</span>);
<a name="l00113"></a>00113       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(server_name);
<a name="l00114"></a>00114       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(keys::PONG));
<a name="l00115"></a>00115       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; keys::PONG &lt;&lt; server_name &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(0));
<a name="l00116"></a>00116       <span class="keywordflow">break</span>;
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     <span class="keywordflow">case</span> SILENCE:               <span class="comment">// No target</span>
<a name="l00119"></a>00119     {
<a name="l00120"></a>00120       <span class="comment">// FIXME.</span>
<a name="l00121"></a>00121       <span class="comment">// For now, just pass it on the server as-is.</span>
<a name="l00122"></a>00122       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#19ff70c7a27c9d832cc072ac7f4add8a" title="Queue message msg with default priority without changing it.">queue_msg_as_is</a>(msg);
<a name="l00123"></a>00123       <span class="keywordflow">break</span>;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125     <span class="keywordflow">case</span> OPER:                  <span class="comment">// No target</span>
<a name="l00126"></a>00126     <span class="keywordflow">case</span> MAP:
<a name="l00127"></a>00127     <span class="keywordflow">case</span> WALLOPS:
<a name="l00128"></a>00128     <span class="keywordflow">case</span> WALLUSERS:
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130       <span class="comment">// FIXME.</span>
<a name="l00131"></a>00131       <span class="comment">// For now, just pass it on the server as-is.</span>
<a name="l00132"></a>00132       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#19ff70c7a27c9d832cc072ac7f4add8a" title="Queue message msg with default priority without changing it.">queue_msg_as_is</a>(msg);
<a name="l00133"></a>00133       <span class="keywordflow">break</span>;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <span class="keywordflow">case</span> STATS:                 <span class="comment">// No target, or server target.</span>
<a name="l00136"></a>00136     <span class="keywordflow">case</span> VERSION:
<a name="l00137"></a>00137     {
<a name="l00138"></a>00138       <span class="comment">// FIXME.</span>
<a name="l00139"></a>00139       <span class="comment">// For now, just pass it on the server as-is.</span>
<a name="l00140"></a>00140       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#19ff70c7a27c9d832cc072ac7f4add8a" title="Queue message msg with default priority without changing it.">queue_msg_as_is</a>(msg);
<a name="l00141"></a>00141       <span class="keywordflow">break</span>;
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143     <span class="keywordflow">case</span> WHO:                   <span class="comment">// Query</span>
<a name="l00144"></a>00144     {
<a name="l00145"></a>00145       <a class="code" href="classWhoRequest.html" title="A WHO request.">WhoRequest</a> who_request(msg.<a class="code" href="classClientMessageIn.html#fee67ebae51ab90fa6f643fd5fd8fe9c" title="Accessor for M_client_session.">client_session</a>(), (msg.<a class="code" href="classMessageIn.html#cc92a979360c4c920199ca8d1f4fd0ba" title="The number of parameters.">params_size</a>() &gt;= 3) ? msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(2) : msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0), msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1));
<a name="l00146"></a>00146       <span class="keywordflow">if</span> (msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>().size() &gt;= 1 &amp;&amp; who_request.options().matches_against_channel() &amp;&amp; <a class="code" href="is__channel_8h.html#9211aa8dc88461be45ad52d918f5782e" title="Returns true if name is a channel name.">is_channel</a>(who_request.mask()))
<a name="l00147"></a>00147       {
<a name="l00148"></a>00148         <span class="comment">// Search in the private network targets map.</span>
<a name="l00149"></a>00149         ClientSession::private_targets_type::iterator priv_iter = <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#077fae5d435ae160b221805648638b4a" title="Return reference to map with private targets.">private_targets</a>().find(who_request.mask());
<a name="l00150"></a>00150         <span class="keywordflow">if</span> (priv_iter != <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#077fae5d435ae160b221805648638b4a" title="Return reference to map with private targets.">private_targets</a>().end())
<a name="l00151"></a>00151         {
<a name="l00152"></a>00152           boost::static_pointer_cast&lt;<a class="code" href="classPrivateTarget.html" title="A fake channel that is used for communication between user and ircproxy.">PrivateTarget</a>&gt;(priv_iter-&gt;second)-&gt;handle_who(who_request);
<a name="l00153"></a>00153           <span class="keywordflow">break</span>;
<a name="l00154"></a>00154         }
<a name="l00155"></a>00155       }
<a name="l00156"></a>00156       <span class="comment">// Not a private channel, pass it on to the server.</span>
<a name="l00157"></a>00157       <a class="code" href="classPseudoMessageOut.html" title="A pseudo output message.">PseudoMessageOut</a> pseudo_msg(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(keys::WHO), <a class="code" href="MessageOut_8h.html#35822c953540e9ad193309b6d4f650112ca27b35b01919ea12c7c3663e633460" title="The message can be sent to the server regardless.">safe_query</a>);
<a name="l00158"></a>00158       pseudo_msg.writeEventRequest(<a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>(), &amp;<a class="code" href="classServerSession.html#4fc533f77c0d9a4285267db38941a83b" title="A write event of a pseudo WHO message happened. Actually write the WHO message.">ServerSession::send_who_write_event</a>, who_request);
<a name="l00159"></a>00159       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(pseudo_msg);
<a name="l00160"></a>00160       <span class="keywordflow">break</span>;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162     <span class="keywordflow">case</span> WHOIS:                 <span class="comment">// Query</span>
<a name="l00163"></a>00163     <span class="keywordflow">case</span> WHOWAS:                <span class="comment">// Query</span>
<a name="l00164"></a>00164     <span class="keywordflow">case</span> LIST:                  <span class="comment">// Query</span>
<a name="l00165"></a>00165     {
<a name="l00166"></a>00166       <span class="comment">// Extract the prefix of the input message.</span>
<a name="l00167"></a>00167       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00168"></a>00168       <span class="comment">// FIXME: needs caching.</span>
<a name="l00169"></a>00169       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00170"></a>00170       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(0));
<a name="l00171"></a>00171       <span class="keywordflow">break</span>;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="keywordflow">case</span> LINKS:                 <span class="comment">// Disabled</span>
<a name="l00174"></a>00174       <span class="keywordflow">break</span>;
<a name="l00175"></a>00175     <span class="keywordflow">case</span> NICK:                  <span class="comment">// Target: this</span>
<a name="l00176"></a>00176       <span class="comment">// Handle NICK</span>
<a name="l00177"></a>00177       msg.<a class="code" href="classClientMessageIn.html#fee67ebae51ab90fa6f643fd5fd8fe9c" title="Accessor for M_client_session.">client_session</a>().<a class="code" href="classClientSession.html#a7d364c5760261681a5794bac289bdbe" title="Called from Identity::new_client_message_received for NICK messages.">new_client_nick_received</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00178"></a>00178       <span class="keywordflow">break</span>;
<a name="l00179"></a>00179     <span class="keywordflow">case</span> QUIT:                  <span class="comment">// Target: this</span>
<a name="l00180"></a>00180       <span class="keywordflow">break</span>;
<a name="l00181"></a>00181     <span class="keywordflow">case</span> KILL:                  <span class="comment">// Target: nick</span>
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00184"></a>00184       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00185"></a>00185       <span class="keywordflow">try</span>
<a name="l00186"></a>00186       {
<a name="l00187"></a>00187         <span class="comment">// Is this a known target?</span>
<a name="l00188"></a>00188         boost::shared_ptr&lt;Target&gt; nick = msg.<a class="code" href="classClientMessageIn.html#fee67ebae51ab90fa6f643fd5fd8fe9c" title="Accessor for M_client_session.">client_session</a>().<a class="code" href="classClientSession.html#059271f1ab7443ab40e5fdf5564e0ce0" title="Get or create a Nick for nick_name.">get_nick</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00189"></a>00189         <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; nick &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(1));
<a name="l00190"></a>00190       }
<a name="l00191"></a>00191       <span class="keywordflow">catch</span>(<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00192"></a>00192       {
<a name="l00193"></a>00193         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));
<a name="l00194"></a>00194         <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(0));
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196       <span class="keywordflow">break</span>;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198     <span class="keywordflow">case</span> MODE:                  <span class="comment">// Target: channel or nick (this)</span>
<a name="l00199"></a>00199     <span class="keywordflow">case</span> PRIVMSG:               <span class="comment">// Target: channel or nick</span>
<a name="l00200"></a>00200     <span class="keywordflow">case</span> NOTICE:                <span class="comment">// Target: channel or nick</span>
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202       <span class="keywordflow">if</span> (!msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>().empty())
<a name="l00203"></a>00203       {
<a name="l00204"></a>00204         <span class="keywordtype">char</span> c = *msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>().front().start();
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (c != <span class="charliteral">'#'</span> &amp;&amp; c != <span class="charliteral">'&amp;'</span>)
<a name="l00206"></a>00206         {
<a name="l00207"></a>00207           <span class="keywordflow">if</span> (msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() == MODE)
<a name="l00208"></a>00208           {
<a name="l00209"></a>00209             <span class="comment">// Handle MODE &lt;nick&gt;</span>
<a name="l00210"></a>00210             <span class="comment">// FIXME: replace ASSERT with code that handles the other case.</span>
<a name="l00211"></a>00211             <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>())); 
<a name="l00212"></a>00212             <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00213"></a>00213             <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00214"></a>00214             <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(1));
<a name="l00215"></a>00215             <span class="keywordflow">break</span>;
<a name="l00216"></a>00216           }
<a name="l00217"></a>00217           <span class="keywordflow">else</span>
<a name="l00218"></a>00218           {
<a name="l00219"></a>00219             <span class="keywordflow">try</span>
<a name="l00220"></a>00220             {
<a name="l00221"></a>00221               <span class="comment">// Is this a known target?</span>
<a name="l00222"></a>00222               msg.<a class="code" href="classClientMessageIn.html#fee67ebae51ab90fa6f643fd5fd8fe9c" title="Accessor for M_client_session.">client_session</a>().<a class="code" href="classClientSession.html#059271f1ab7443ab40e5fdf5564e0ce0" title="Get or create a Nick for nick_name.">get_nick</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0))-&gt;<a class="code" href="classIdentity.html#3c41a896404c73d7f84a53e0a430c0c1" title="Called when a new message was received from the associated client.">new_client_message_received</a>(msg);
<a name="l00223"></a>00223             }
<a name="l00224"></a>00224             <span class="keywordflow">catch</span>(<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00225"></a>00225             {
<a name="l00226"></a>00226               Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));
<a name="l00227"></a>00227               <span class="comment">// Client is sending a message to an unknown target.</span>
<a name="l00228"></a>00228               <span class="comment">// FIXME: Shouldn't we do something here?</span>
<a name="l00229"></a>00229               <span class="comment">// Pass the message as-is to the server.</span>
<a name="l00230"></a>00230               <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#19ff70c7a27c9d832cc072ac7f4add8a" title="Queue message msg with default priority without changing it.">queue_msg_as_is</a>(msg);
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232           }
<a name="l00233"></a>00233           <span class="keywordflow">break</span>;
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235       }
<a name="l00236"></a>00236       <span class="comment">/* FALL-THROUGH */</span>
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     <span class="keywordflow">case</span> INVITE:                <span class="comment">// Target: channel</span>
<a name="l00239"></a>00239     <span class="keywordflow">case</span> CPRIVMSG:              <span class="comment">// Target: channel</span>
<a name="l00240"></a>00240     <span class="keywordflow">case</span> CNOTICE:               <span class="comment">// Target: channel</span>
<a name="l00241"></a>00241     <span class="keywordflow">case</span> JOIN:                  <span class="comment">// Target: channel</span>
<a name="l00242"></a>00242     <span class="keywordflow">case</span> PART:                  <span class="comment">// Target: channel</span>
<a name="l00243"></a>00243     <span class="keywordflow">case</span> KICK:                  <span class="comment">// Target: channel</span>
<a name="l00244"></a>00244     <span class="keywordflow">case</span> NAMES:                 <span class="comment">// Target: channel</span>
<a name="l00245"></a>00245     <span class="keywordflow">case</span> TOPIC:                 <span class="comment">// Target: channel</span>
<a name="l00246"></a>00246       <span class="keywordflow">try</span>
<a name="l00247"></a>00247       {
<a name="l00248"></a>00248         <span class="comment">// Are we really on this channel?</span>
<a name="l00249"></a>00249         <a class="code" href="classTarget.html#1356d7463258b6863783b7e14ff21b0b" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::clientside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0))-&gt;<a class="code" href="classIdentity.html#3c41a896404c73d7f84a53e0a430c0c1" title="Called when a new message was received from the associated client.">new_client_message_received</a>(msg);
<a name="l00250"></a>00250       }
<a name="l00251"></a>00251       <span class="keywordflow">catch</span>(<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00252"></a>00252       {
<a name="l00253"></a>00253         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));
<a name="l00254"></a>00254         <span class="comment">// FIXME: Shouldn't we do something here?</span>
<a name="l00255"></a>00255         <span class="comment">// Client targets an unknown channel. Just pass the message on as-is to the server.</span>
<a name="l00256"></a>00256         <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#19ff70c7a27c9d832cc072ac7f4add8a" title="Queue message msg with default priority without changing it.">queue_msg_as_is</a>(msg);
<a name="l00257"></a>00257       }
<a name="l00258"></a>00258       <span class="keywordflow">break</span>;
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="keywordtype">void</span> Identity::do_quit(boost::shared_ptr&lt;Nick&gt; nick, std::string <span class="keyword">const</span>&amp; quit_message)
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!nick-&gt;is_me());
<a name="l00265"></a>00265   <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(nick);
<a name="l00266"></a>00266   <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(keys::QUIT));
<a name="l00267"></a>00267   <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; keys::QUIT &lt;&lt; <a class="code" href="classJustInTimeLast.html" title="A just-in-time manipulator. This causes the passed token to be prepended with a colon...">JustInTimeLast</a>(quit_message));
<a name="l00268"></a>00268   <a class="code" href="classNickData.html#b7ee503b026b741e32b3d16dd497d3f5" title="The type of NickData::M_common_channels.">NickData::common_channels_type</a>&amp; common_channels(nick-&gt;data().common_channels());
<a name="l00269"></a>00269   Dout(<a class="code" href="namespacedebug_1_1channels_1_1dc.html#c7ed0ee7657485705dfdf1910619198a" title="This debug channel is used for nick/channel maps administration tracking.">dc::maps</a>, <span class="stringliteral">"QUIT by "</span> &lt;&lt; nick &lt;&lt; <span class="stringliteral">" who is on "</span> &lt;&lt; common_channels.size() &lt;&lt; <span class="stringliteral">" common channels."</span>);
<a name="l00270"></a>00270   NickData::common_channels_type::iterator iter = common_channels.begin();
<a name="l00271"></a>00271   <span class="keywordflow">while</span> (iter != common_channels.end())
<a name="l00272"></a>00272   {
<a name="l00273"></a>00273     <span class="comment">// This call will erase the element that iter points to, therefore we have to increment it here.</span>
<a name="l00274"></a>00274     (iter++)-&gt;second.lock()-&gt;sub_joined_nick(nick);
<a name="l00275"></a>00275   }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="classIdentity.html#db9bc35ffd8b4c4df8fcd662701ce1a4">00278</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#db9bc35ffd8b4c4df8fcd662701ce1a4" title="Called when a new message was received from the associated server.">Identity::new_server_message_received</a>(<a class="code" href="classServerMessageIn.html" title="An IRC message as received from a server.">ServerMessageIn</a> <span class="keyword">const</span>&amp; msg)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!debug::secondary_connection);
<a name="l00281"></a>00281   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"Identity::new_server_message_received("</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283   <span class="keywordflow">switch</span> (msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>())
<a name="l00284"></a>00284   {
<a name="l00285"></a>00285     <span class="keyword">using namespace </span>keys;
<a name="l00286"></a>00286     <span class="keywordflow">case</span> 315:   <span class="comment">// End of /WHO list.</span>
<a name="l00287"></a>00287     {
<a name="l00288"></a>00288       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00289"></a>00289       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00290"></a>00290       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(1));
<a name="l00291"></a>00291 <span class="preprocessor">#ifdef CWDEBUG</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>      <a class="code" href="classWhoRequest.html" title="A WHO request.">WhoRequest</a> who_request(<a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().current_who_request());
<a name="l00293"></a>00293       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(who_request.<a class="code" href="classWhoRequest.html#d44ee347083f133d51caf0c2e04f0ff9" title="Accessor for the mask.">mask</a>() == msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1));
<a name="l00294"></a>00294 <span class="preprocessor">#endif</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>      <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#e6e767a4bc2fd4a4dc2cd4330144a34a" title="Pop the first element of M_who_queue.">pop_who_request</a>();
<a name="l00296"></a>00296       <span class="keywordflow">break</span>;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">case</span> 324:
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00301"></a>00301       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00302"></a>00302       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00303"></a>00303       std::string my_nick_name(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00304"></a>00304       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(my_nick_name == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00305"></a>00305       <span class="comment">// Write the first part of the message.</span>
<a name="l00306"></a>00306       msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00307"></a>00307       <span class="comment">// FIXME: decode channel modes.</span>
<a name="l00308"></a>00308       <span class="keywordflow">try</span>
<a name="l00309"></a>00309       {
<a name="l00310"></a>00310         boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1)));
<a name="l00311"></a>00311         msgout &lt;&lt; channel;
<a name="l00312"></a>00312       }
<a name="l00313"></a>00313       <span class="keywordflow">catch</span> (<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00314"></a>00314       {
<a name="l00315"></a>00315         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00316"></a>00316         msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1);
<a name="l00317"></a>00317       }
<a name="l00318"></a>00318       msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(2);
<a name="l00319"></a>00319       <span class="comment">// Write the message.</span>
<a name="l00320"></a>00320       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout);
<a name="l00321"></a>00321       <span class="keywordflow">break</span>;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     <span class="keywordflow">case</span> 329:   <span class="comment">// Channel timestamp.</span>
<a name="l00324"></a>00324     {
<a name="l00325"></a>00325       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00326"></a>00326       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00327"></a>00327       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00328"></a>00328       std::string my_nick_name(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00329"></a>00329       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(my_nick_name == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00330"></a>00330       <span class="comment">// Write the first part of the message.</span>
<a name="l00331"></a>00331       msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00332"></a>00332       time_t creation_time = atol(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(2).c_str());
<a name="l00333"></a>00333       <span class="keywordflow">try</span>
<a name="l00334"></a>00334       {
<a name="l00335"></a>00335         boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1)));
<a name="l00336"></a>00336         channel-&gt;set_creation_time(creation_time);
<a name="l00337"></a>00337         msgout &lt;&lt; channel;
<a name="l00338"></a>00338       }
<a name="l00339"></a>00339       <span class="keywordflow">catch</span> (<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00340"></a>00340       {
<a name="l00341"></a>00341         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00342"></a>00342         msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1);
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344       msgout &lt;&lt; creation_time;
<a name="l00345"></a>00345       <span class="comment">// Write the message.</span>
<a name="l00346"></a>00346       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout);
<a name="l00347"></a>00347       <span class="keywordflow">break</span>;
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349     <span class="keywordflow">case</span> 352:   <span class="comment">// WHO, without fields, reply.</span>
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351       <span class="comment">// Get the corresponding WhoRequest.</span>
<a name="l00352"></a>00352       <a class="code" href="classWhoRequest.html" title="A WHO request.">WhoRequest</a> who_request(<a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().current_who_request());
<a name="l00353"></a>00353       Dout(dc::notice, <span class="stringliteral">"Decoding numeric 352 for WHO request "</span> &lt;&lt; who_request);
<a name="l00354"></a>00354       <span class="comment">// The format of this numeric is:</span>
<a name="l00355"></a>00355       <span class="comment">// 0: My nick</span>
<a name="l00356"></a>00356       <span class="comment">// 1: (first) channel</span>
<a name="l00357"></a>00357       <span class="comment">// 2: username</span>
<a name="l00358"></a>00358       <span class="comment">// 3: hostname</span>
<a name="l00359"></a>00359       <span class="comment">// 4: servername</span>
<a name="l00360"></a>00360       <span class="comment">// 5: nick</span>
<a name="l00361"></a>00361       <span class="comment">// 6: flags</span>
<a name="l00362"></a>00362       <span class="comment">// 7: hop realname</span>
<a name="l00363"></a>00363       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00364"></a>00364       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00365"></a>00365       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00366"></a>00366       std::string my_nick_name(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00367"></a>00367       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(my_nick_name == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00368"></a>00368       <span class="comment">// Write the first part of the message.</span>
<a name="l00369"></a>00369       msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00370"></a>00370       <span class="keywordflow">try</span>
<a name="l00371"></a>00371       {
<a name="l00372"></a>00372         boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1)));
<a name="l00373"></a>00373         msgout &lt;&lt; channel;
<a name="l00374"></a>00374       }
<a name="l00375"></a>00375       <span class="keywordflow">catch</span> (<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00376"></a>00376       {
<a name="l00377"></a>00377         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00378"></a>00378         msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1); 
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       std::string username(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(2));
<a name="l00381"></a>00381       std::string <a class="code" href="classIdentity.html#ef9f32c81621f82010e68efea93c3efc" title="Returns a best-guess for the users host name.">hostname</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(3));
<a name="l00382"></a>00382       std::string servername(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(4));
<a name="l00383"></a>00383       std::string flags(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(6));
<a name="l00384"></a>00384       std::string realname(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(7));
<a name="l00385"></a>00385       <span class="keywordtype">int</span> hopcount = atoi(realname.c_str());
<a name="l00386"></a>00386       realname = realname.substr(realname.find(<span class="charliteral">' '</span>) + 1);
<a name="l00387"></a>00387       msgout &lt;&lt; username &lt;&lt; <a class="code" href="classIdentity.html#ef9f32c81621f82010e68efea93c3efc" title="Returns a best-guess for the users host name.">hostname</a> &lt;&lt; servername;
<a name="l00388"></a>00388       <span class="keywordflow">try</span>
<a name="l00389"></a>00389       {
<a name="l00390"></a>00390         boost::shared_ptr&lt;Nick&gt; nick(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>().<a class="code" href="classServerSession.html#a2a8691f762c3c2338e52ae91dcbc592" title="Get or create a Nick for nick_name.">get_nick</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(5)));
<a name="l00391"></a>00391         msgout &lt;&lt; nick;
<a name="l00392"></a>00392         nick-&gt;data().set_username(username);
<a name="l00393"></a>00393         nick-&gt;data().set_hostname(<a class="code" href="classIdentity.html#ef9f32c81621f82010e68efea93c3efc" title="Returns a best-guess for the users host name.">hostname</a>);
<a name="l00394"></a>00394         nick-&gt;data().set_realname(realname);
<a name="l00395"></a>00395         nick-&gt;data().set_hopcount(hopcount);
<a name="l00396"></a>00396         nick-&gt;data().set_flags(<a class="code" href="classFlags.html" title="A class to store the relevant part of the flags field from a WHO reply.">Flags</a>(<a class="code" href="classIdentity.html#947c5aff4de5d531cd229df61521f419" title="Return the network object of the connection belonging to this identity.">network</a>(), flags));
<a name="l00397"></a>00397       }
<a name="l00398"></a>00398       <span class="keywordflow">catch</span>(<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00399"></a>00399       {
<a name="l00400"></a>00400         Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00401"></a>00401         msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(5);
<a name="l00402"></a>00402       }
<a name="l00403"></a>00403       msgout &lt;&lt; flags &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(7);
<a name="l00404"></a>00404       <span class="comment">// Write the message.</span>
<a name="l00405"></a>00405       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout);
<a name="l00406"></a>00406       <span class="keywordflow">break</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     <span class="keywordflow">case</span> 354:   <span class="comment">// WHO, with fields, reply.</span>
<a name="l00409"></a>00409     {
<a name="l00410"></a>00410       <span class="comment">// Get the corresponding WhoRequest.</span>
<a name="l00411"></a>00411       <a class="code" href="classWhoRequest.html" title="A WHO request.">WhoRequest</a> who_request(<a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().current_who_request());
<a name="l00412"></a>00412       Dout(dc::notice, <span class="stringliteral">"Decoding numeric 354 for WHO request "</span> &lt;&lt; who_request);
<a name="l00413"></a>00413       <span class="comment">// The format of this numeric is:</span>
<a name="l00414"></a>00414       <span class="comment">// - t: The left-most three digits of the query type (or 0, if there was none, or non-numeric, or negative).</span>
<a name="l00415"></a>00415       <span class="comment">// - c: The (first) channel name.</span>
<a name="l00416"></a>00416       <span class="comment">// - u: User name with eventual ~.</span>
<a name="l00417"></a>00417       <span class="comment">// - i: IP</span>
<a name="l00418"></a>00418       <span class="comment">// - h: Host name.</span>
<a name="l00419"></a>00419       <span class="comment">// - s: Server name.</span>
<a name="l00420"></a>00420       <span class="comment">// - n: Nick name.</span>
<a name="l00421"></a>00421       <span class="comment">// - f: Flags (all of them).</span>
<a name="l00422"></a>00422       <span class="comment">// - d: Hop count. 3 for non-Opers.</span>
<a name="l00423"></a>00423       <span class="comment">// - l: Idle time (0 for remote users). Also 0 for non-Opers.</span>
<a name="l00424"></a>00424       <span class="comment">// - a: Account name.</span>
<a name="l00425"></a>00425       <span class="comment">// - r: Real name.</span>
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00428"></a>00428       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00429"></a>00429       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00430"></a>00430       std::string my_nick_name(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00431"></a>00431       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(my_nick_name == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00432"></a>00432       <span class="comment">// Write the first part of the message.</span>
<a name="l00433"></a>00433       msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00434"></a>00434 
<a name="l00435"></a>00435       <span class="keywordtype">int</span> n = 0;
<a name="l00436"></a>00436       <span class="comment">// Run over all field flags.</span>
<a name="l00437"></a>00437       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> field = 1; field &lt; field_percentage; field &lt;&lt;= 1)
<a name="l00438"></a>00438       {
<a name="l00439"></a>00439         <span class="keywordflow">if</span> ((who_request.<a class="code" href="classWhoRequest.html#c87f007d4770db724365182346f5685f" title="Accessor for the options.">options</a>().<a class="code" href="classWhoOptions.html#3544390ae279cceb766bd31bf25257f3" title="Accessor for fields.">fields</a>() &amp; field))
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441           <span class="comment">// Next message parameter.</span>
<a name="l00442"></a>00442           ++n;
<a name="l00443"></a>00443           <span class="comment">// Ok, this field exists. Write it out.</span>
<a name="l00444"></a>00444           <span class="keywordflow">if</span> (field == field_c)         <span class="comment">// A channel name?</span>
<a name="l00445"></a>00445           {
<a name="l00446"></a>00446             <span class="keywordflow">try</span>
<a name="l00447"></a>00447             {
<a name="l00448"></a>00448               boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n)));
<a name="l00449"></a>00449               msgout &lt;&lt; channel;
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451             <span class="keywordflow">catch</span> (<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00452"></a>00452             {
<a name="l00453"></a>00453               Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00454"></a>00454               msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n); 
<a name="l00455"></a>00455             }
<a name="l00456"></a>00456           }
<a name="l00457"></a>00457           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field == field_n)    <span class="comment">// A nick name?</span>
<a name="l00458"></a>00458           {
<a name="l00459"></a>00459             <span class="keywordflow">try</span>
<a name="l00460"></a>00460             {
<a name="l00461"></a>00461               boost::shared_ptr&lt;Nick&gt; nick(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>().<a class="code" href="classServerSession.html#a2a8691f762c3c2338e52ae91dcbc592" title="Get or create a Nick for nick_name.">get_nick</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n)));
<a name="l00462"></a>00462               msgout &lt;&lt; nick;
<a name="l00463"></a>00463               <span class="keywordtype">int</span> n2 = 0;
<a name="l00464"></a>00464               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> field2 = 1; field2 &lt; field_percentage; field2 &lt;&lt;= 1)
<a name="l00465"></a>00465                 <span class="keywordflow">if</span> ((who_request.<a class="code" href="classWhoRequest.html#c87f007d4770db724365182346f5685f" title="Accessor for the options.">options</a>().<a class="code" href="classWhoOptions.html#3544390ae279cceb766bd31bf25257f3" title="Accessor for fields.">fields</a>() &amp; field2))
<a name="l00466"></a>00466                 {
<a name="l00467"></a>00467                   ++n2;
<a name="l00468"></a>00468                   <span class="keywordflow">switch</span>(field2)
<a name="l00469"></a>00469                   {
<a name="l00470"></a>00470                     <span class="keywordflow">case</span> field_u:
<a name="l00471"></a>00471                       nick-&gt;data().set_username(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2));
<a name="l00472"></a>00472                       <span class="keywordflow">break</span>;
<a name="l00473"></a>00473                     <span class="keywordflow">case</span> field_h:
<a name="l00474"></a>00474                       nick-&gt;data().set_hostname(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2));
<a name="l00475"></a>00475                       <span class="keywordflow">break</span>;
<a name="l00476"></a>00476                     <span class="keywordflow">case</span> field_i:
<a name="l00477"></a>00477                       nick-&gt;data().set_ip(<a class="code" href="classIPNumber.html" title="An IP number.">IPNumber</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2)));
<a name="l00478"></a>00478                       <span class="keywordflow">break</span>;
<a name="l00479"></a>00479                     <span class="keywordflow">case</span> field_r:
<a name="l00480"></a>00480                       nick-&gt;data().set_realname(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2));
<a name="l00481"></a>00481                       <span class="keywordflow">break</span>;
<a name="l00482"></a>00482                     <span class="keywordflow">case</span> field_d:
<a name="l00483"></a>00483                       nick-&gt;data().set_hopcount(atoi(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2).c_str()));
<a name="l00484"></a>00484                       <span class="keywordflow">break</span>;
<a name="l00485"></a>00485                     <span class="keywordflow">case</span> field_f:
<a name="l00486"></a>00486                       nick-&gt;data().set_flags(<a class="code" href="classFlags.html" title="A class to store the relevant part of the flags field from a WHO reply.">Flags</a>(<a class="code" href="classIdentity.html#947c5aff4de5d531cd229df61521f419" title="Return the network object of the connection belonging to this identity.">network</a>(), msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2)));
<a name="l00487"></a>00487                       <span class="keywordflow">break</span>;
<a name="l00488"></a>00488                     <span class="keywordflow">case</span> field_s:
<a name="l00489"></a>00489                       nick-&gt;data().set_servername(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2));
<a name="l00490"></a>00490                       <span class="keywordflow">break</span>;
<a name="l00491"></a>00491                     <span class="keywordflow">case</span> field_l:
<a name="l00492"></a>00492                       nick-&gt;data().set_idletime(atoi(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2).c_str()));
<a name="l00493"></a>00493                       <span class="keywordflow">break</span>;
<a name="l00494"></a>00494                     <span class="keywordflow">case</span> field_a:
<a name="l00495"></a>00495                       nick-&gt;data().set_accountname(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n2));
<a name="l00496"></a>00496                       <span class="keywordflow">break</span>;
<a name="l00497"></a>00497                   }
<a name="l00498"></a>00498                 }
<a name="l00499"></a>00499             }
<a name="l00500"></a>00500             <span class="keywordflow">catch</span>(<a class="code" href="classunknown__target.html" title="An exception class.">unknown_target</a>&amp; error)
<a name="l00501"></a>00501             {
<a name="l00502"></a>00502               Debug(<a class="code" href="namespaceedragon.html#bfd7060563c54aecc5df0be27066dcd1" title="Debugging function.">edragon::caught</a>(error));   
<a name="l00503"></a>00503               msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n);
<a name="l00504"></a>00504             }
<a name="l00505"></a>00505           }
<a name="l00506"></a>00506           <span class="keywordflow">else</span>
<a name="l00507"></a>00507             msgout &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(n);
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509       }
<a name="l00510"></a>00510       <span class="comment">// Write the message.</span>
<a name="l00511"></a>00511       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout);
<a name="l00512"></a>00512       <span class="keywordflow">break</span>;
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     <span class="keywordflow">case</span> 353:   <span class="comment">// NAMES reply</span>
<a name="l00515"></a>00515     {
<a name="l00516"></a>00516       <span class="comment">// Get prefix.</span>
<a name="l00517"></a>00517       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00518"></a>00518       <span class="comment">// Prepare message to be sent to client.</span>
<a name="l00519"></a>00519       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00520"></a>00520       <span class="comment">// Lookup the channel.</span>
<a name="l00521"></a>00521       boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(2)));
<a name="l00522"></a>00522       <span class="keywordtype">bool</span> received_first_names = channel-&gt;received_names();
<a name="l00523"></a>00523       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00524"></a>00524       std::string my_nick_name(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00525"></a>00525       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(my_nick_name == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00526"></a>00526       <span class="comment">// Write first part of message.</span>
<a name="l00527"></a>00527       msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1) &lt;&lt; channel;
<a name="l00528"></a>00528       <span class="comment">// Run over each parameter.</span>
<a name="l00529"></a>00529       <a class="code" href="classMsgPart.html" title="Like MessageIn::Part but with a copy of msg_block_ct to keep the message block alive...">MsgPart</a> names_list(msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(3));
<a name="l00530"></a>00530       <span class="keywordtype">char</span> <span class="keyword">const</span>* list_start = names_list.start();
<a name="l00531"></a>00531       <span class="keywordflow">if</span> (*list_start == <span class="charliteral">':'</span>)
<a name="l00532"></a>00532         ++list_start;
<a name="l00533"></a>00533       <span class="keywordtype">char</span> <span class="keyword">const</span>* <span class="keyword">const</span> list_end = names_list.end();
<a name="l00534"></a>00534       <span class="keywordtype">char</span> <span class="keyword">const</span>* word_end;
<a name="l00535"></a>00535       <span class="keywordflow">for</span> (<span class="keywordtype">char</span> <span class="keyword">const</span>* word_start = list_start; word_start &lt; list_end; word_start = word_end + 1)
<a name="l00536"></a>00536       {
<a name="l00537"></a>00537         <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(*word_start != <span class="charliteral">' '</span>);
<a name="l00538"></a>00538         <span class="keywordflow">for</span> (word_end = word_start; word_end &lt; list_end &amp;&amp; *word_end != <span class="charliteral">' '</span>; ++word_end);
<a name="l00539"></a>00539         std::string param(word_start, word_end - word_start);
<a name="l00540"></a>00540         <span class="keywordflow">if</span> (!IsNickChar(*word_start))
<a name="l00541"></a>00541         {
<a name="l00542"></a>00542           <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(*word_start == <span class="charliteral">'@'</span> || *word_start == <span class="charliteral">'+'</span>);
<a name="l00543"></a>00543           std::string nick_name(word_start + 1, word_end - word_start - 1);
<a name="l00544"></a>00544           boost::shared_ptr&lt;Nick&gt; nick;
<a name="l00545"></a>00545           <span class="keywordflow">if</span> (received_first_names)
<a name="l00546"></a>00546             nick = <a class="code" href="classTarget.html#18128829aa71a1dd131232505030de93" title="Return a shared pointer to the Nick object with name nick_name that is joined to...">Target::get_joined_nick</a>(*<span class="keyword">this</span>, nick_name, channel);
<a name="l00547"></a>00547           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nick_name == my_nick_name)   <span class="comment">// Was already added by the JOIN.</span>
<a name="l00548"></a>00548             nick = <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00549"></a>00549           <span class="keywordflow">else</span>
<a name="l00550"></a>00550             nick = <a class="code" href="classTarget.html#bc965aafc07a935a4ea5d6d84b5b2065" title="Add a new nick with name nick_name to the joined channel with name channel_name.">Target::add_joined_nick</a>(*<span class="keyword">this</span>, nick_name, channel);
<a name="l00551"></a>00551           msgout &lt;&lt; *word_start &lt;&lt; <a class="code" href="classJustInTimeCatenate.html" title="A just-in-time manipulator. This causes the passed token to be catenated to the previous...">JustInTimeCatenate</a>(nick);
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553         <span class="keywordflow">else</span>
<a name="l00554"></a>00554         {
<a name="l00555"></a>00555           std::string nick_name(word_start, word_end - word_start);
<a name="l00556"></a>00556           boost::shared_ptr&lt;Nick&gt; nick;
<a name="l00557"></a>00557           <span class="keywordflow">if</span> (received_first_names)
<a name="l00558"></a>00558             nick = <a class="code" href="classTarget.html#18128829aa71a1dd131232505030de93" title="Return a shared pointer to the Nick object with name nick_name that is joined to...">Target::get_joined_nick</a>(*<span class="keyword">this</span>, nick_name, channel);
<a name="l00559"></a>00559           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nick_name == my_nick_name)   <span class="comment">// Was already added by the JOIN.</span>
<a name="l00560"></a>00560             nick = <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>();
<a name="l00561"></a>00561           <span class="keywordflow">else</span>
<a name="l00562"></a>00562             nick = <a class="code" href="classTarget.html#bc965aafc07a935a4ea5d6d84b5b2065" title="Add a new nick with name nick_name to the joined channel with name channel_name.">Target::add_joined_nick</a>(*<span class="keyword">this</span>, nick_name, channel);
<a name="l00563"></a>00563           msgout &lt;&lt; nick;
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565       }
<a name="l00566"></a>00566       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout);
<a name="l00567"></a>00567       <span class="keywordflow">break</span>;
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <span class="keywordflow">case</span> 366:   <span class="comment">// End of /NAMES list.</span>
<a name="l00570"></a>00570     {
<a name="l00571"></a>00571       <span class="comment">// Get prefix.</span>
<a name="l00572"></a>00572       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00573"></a>00573       <span class="comment">// Prepare message to be sent to client.</span>
<a name="l00574"></a>00574       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00575"></a>00575       <span class="comment">// Lookup the channel.</span>
<a name="l00576"></a>00576       boost::shared_ptr&lt;Channel&gt; channel(<a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1)));
<a name="l00577"></a>00577       <span class="keywordflow">if</span> (!channel-&gt;received_names())
<a name="l00578"></a>00578       {
<a name="l00579"></a>00579         <span class="comment">// Tell channel we received the first 366.</span>
<a name="l00580"></a>00580         channel-&gt;set_received_names();
<a name="l00581"></a>00581       }
<a name="l00582"></a>00582       <span class="comment">// Parameter 0 should be my own nick name.</span>
<a name="l00583"></a>00583       <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) == <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>()-&gt;in_name(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>()));
<a name="l00584"></a>00584       <span class="comment">// Pass message on the client.</span>
<a name="l00585"></a>00585       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>() &lt;&lt; channel &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(2));
<a name="l00586"></a>00586       <span class="keywordflow">break</span>;
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588     <span class="keywordflow">case</span> 433:   <span class="comment">// Nickname is already in use.</span>
<a name="l00589"></a>00589       <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#2d354747ac77dc1669ffe01f92bfcf03" title="Called when a 433 is received from the server.">inuse</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(1));
<a name="l00590"></a>00590       <span class="keywordflow">break</span>;
<a name="l00591"></a>00591     <span class="keywordflow">case</span> 451:   <span class="comment">// Register first</span>
<a name="l00592"></a>00592       <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().<a class="code" href="classServerConnection.html#46893748168791f5ec68caca30b07af1" title="Return the state of the connection.">state</a>() == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2e329594b1df5c5307e5e5126edb1d605" title="PONG and MODE +i sent.">pong_sent</a>)
<a name="l00593"></a>00593       {
<a name="l00594"></a>00594         <span class="comment">// This probably means that something went wrong with the registration part.</span>
<a name="l00595"></a>00595         <span class="comment">// For example Undernet server version 2.10.12.10 has no means to set MODE +xi</span>
<a name="l00596"></a>00596         <span class="comment">// with the USER command, but requires hostname and ident lookup to be finished</span>
<a name="l00597"></a>00597         <span class="comment">// before it considers registration to be finished. Therefore it is not possible</span>
<a name="l00598"></a>00598         <span class="comment">// to send the PONG and the MODE +ix in one packet (as we do) until after the</span>
<a name="l00599"></a>00599         <span class="comment">// hostname and ident look ups actually have finished. However, because we don't</span>
<a name="l00600"></a>00600         <span class="comment">// know if those lookups are merely delayed a lot, or that we aren't connected</span>
<a name="l00601"></a>00601         <span class="comment">// to an undernet server, we send the PONG and MODE anyway after a certain timeout.</span>
<a name="l00602"></a>00602         <span class="comment">// If the MODE failed, we are vulnerable. Disconnect immediately.</span>
<a name="l00603"></a>00603         <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>() &lt;&lt; <span class="stringliteral">"QUIT\r\n"</span> &lt;&lt; std::flush;
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605       <span class="keywordflow">break</span>;
<a name="l00606"></a>00606     <span class="keywordflow">case</span> QUIT:
<a name="l00607"></a>00607       do_quit(msg.<a class="code" href="classMessageIn.html#7118ac35ffbc7610c82481ac4d1d81da" title="The prefix.">prefix</a>().<a class="code" href="classPrefix.html#bda8482a5b694d77329f8e11a6267eb4" title="Return shared pointer to underlying nick.">get_nick</a>(), msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00608"></a>00608       <span class="keywordflow">break</span>;
<a name="l00609"></a>00609     <span class="keywordflow">case</span> NICK:
<a name="l00610"></a>00610     {
<a name="l00611"></a>00611       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00612"></a>00612       <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> old_prefix(prefix.<a class="code" href="classPrefix.html#4f2c29f18236a188c6aaa0c0bf774464" title="Return the clientside prefix.">out_prefix</a>(<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>()));
<a name="l00613"></a>00613       boost::shared_ptr&lt;Nick&gt; nick(prefix.<a class="code" href="classPrefix.html#bda8482a5b694d77329f8e11a6267eb4" title="Return shared pointer to underlying nick.">get_nick</a>());
<a name="l00614"></a>00614       nick-&gt;serverside_nick_changed_to(msg.<a class="code" href="classServerMessageIn.html#21e92209f98b95e2698bb340b16b5af4" title="Accessor for M_server_session.">server_session</a>(), msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));     <span class="comment">// This updates the maps.</span>
<a name="l00615"></a>00615       <span class="comment">// FIXME: check for collisions etc.</span>
<a name="l00616"></a>00616       nick-&gt;clientside_nick_changed_to(<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>(), msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));         <span class="comment">// This is passed as parameter 0 to the client in the message below.</span>
<a name="l00617"></a>00617       <span class="comment">// Pass the message as-is to the client.</span>
<a name="l00618"></a>00618       <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00619"></a>00619       <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; old_prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; nick);
<a name="l00620"></a>00620       <span class="keywordflow">break</span>;
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622     <span class="keywordflow">case</span> NOTICE:                <span class="comment">// Target: channel or nick</span>
<a name="l00623"></a>00623       <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#bf3c39a512dcf261dff344aa87d4cceb" title="Return the primary server connection object.">server_connection</a>().<a class="code" href="classServerConnection.html#46893748168791f5ec68caca30b07af1" title="Return the state of the connection.">state</a>() &lt;= <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2e329594b1df5c5307e5e5126edb1d605" title="PONG and MODE +i sent.">pong_sent</a>)     <span class="comment">// On the last AUTH message the state is already set to pong_sent.</span>
<a name="l00624"></a>00624         <span class="keywordflow">break</span>;                  <span class="comment">// Ignore NOTICE AUTH messages in the beginning (already handled).</span>
<a name="l00625"></a>00625       <span class="comment">/* FALL-THROUGH */</span>
<a name="l00626"></a>00626     <span class="keywordflow">case</span> PRIVMSG:               <span class="comment">// Target: channel or nick</span>
<a name="l00627"></a>00627     {
<a name="l00628"></a>00628       <span class="keywordflow">if</span> (msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>().empty())
<a name="l00629"></a>00629         <span class="keywordflow">break</span>;                  <span class="comment">// Should never happen.</span>
<a name="l00630"></a>00630       <span class="keywordtype">char</span> c = *msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>().front().start();
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (c != <span class="charliteral">'#'</span> &amp;&amp; c != <span class="charliteral">'&amp;'</span> &amp;&amp; c != <span class="charliteral">'@'</span>)
<a name="l00632"></a>00632       {
<a name="l00633"></a>00633         <span class="comment">// We should only receive PRIVMSG, NOTICE and user MODE's for ourselves.</span>
<a name="l00634"></a>00634         <span class="comment">// A NOTICE can be sent to $mask or * as well.</span>
<a name="l00635"></a>00635         <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(c == <span class="charliteral">'$'</span> || msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) == <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#9ac7a7129697b0c86dc1a3131ad8bafd" title="Returns the last NICK received.">in_nick</a>() || (msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() == NOTICE &amp;&amp; msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) == <span class="stringliteral">"*"</span>));
<a name="l00636"></a>00636         <span class="comment">// Received private PRIVMSG or NOTICE.</span>
<a name="l00637"></a>00637         <span class="comment">// Pass to client as-is.</span>
<a name="l00638"></a>00638         <a class="code" href="classPrefix.html" title="A class representing a message prefix.">Prefix</a> prefix(msg);
<a name="l00639"></a>00639         <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>()));
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (c == <span class="charliteral">'$'</span> || msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) == <span class="stringliteral">"*"</span>)
<a name="l00641"></a>00641           <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(0));
<a name="l00642"></a>00642         <span class="keywordflow">else</span>
<a name="l00643"></a>00643           <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#b241a7f7189af7a21af82dff45277a0a" title="Send an output message to this session.">queue_msg</a>(msgout &lt;&lt; prefix &lt;&lt; msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() &lt;&lt; <a class="code" href="classIdentity.html#d7db39997b22c1d5f8fb7014eb438a50" title="Returns a pointer to my Nick object.">mynick</a>() &lt;&lt; msg.<a class="code" href="classMessageIn.html#3c86c93bfe6cdea3d3928dd8ddddd191" title="A const reference to the vector with parameter Parts.">params</a>(1));
<a name="l00644"></a>00644         <span class="keywordflow">break</span>;
<a name="l00645"></a>00645       } 
<a name="l00646"></a>00646       <span class="comment">/* FALL-THROUGH */</span>
<a name="l00647"></a>00647     }
<a name="l00648"></a>00648     <span class="keywordflow">case</span> MODE:                  <span class="comment">// Target: channel</span>
<a name="l00649"></a>00649     <span class="keywordflow">case</span> PART:                  <span class="comment">// Target: channel</span>
<a name="l00650"></a>00650     <span class="keywordflow">case</span> KICK:                  <span class="comment">// Target: channel</span>
<a name="l00651"></a>00651     <span class="keywordflow">case</span> TOPIC:                 <span class="comment">// Target: channel</span>
<a name="l00652"></a>00652     {
<a name="l00653"></a>00653       <span class="comment">// If we receive a message from the server targetted to a channel, we should already</span>
<a name="l00654"></a>00654       <span class="comment">// be on the channel, so there is no need to catch the unknown_target exception here.</span>
<a name="l00655"></a>00655       <span class="comment">// If it's JOIN we might not be on the channel, but in that case we create it here.</span>
<a name="l00656"></a>00656       <a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0), msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() == JOIN)-&gt;<a class="code" href="classIdentity.html#db9bc35ffd8b4c4df8fcd662701ce1a4" title="Called when a new message was received from the associated server.">new_server_message_received</a>(msg);
<a name="l00657"></a>00657       <span class="keywordflow">break</span>;
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659     <span class="keywordflow">case</span> JOIN:                  <span class="comment">// Target: channel</span>
<a name="l00660"></a>00660     {
<a name="l00661"></a>00661       <a class="code" href="classTarget.html#2c3e405260ba51be778e93e3830d2a0e" title="Retrieve a shared pointer to the Channel object for channel_name.">Target::serverside_get_channel</a>(*<span class="keyword">this</span>, msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0), msg.<a class="code" href="classMessageIn.html#63147fe442cac6236904e034bebfb4b5" title="Numeric representation of command or numeric.">key</a>() == JOIN)-&gt;<a class="code" href="classIdentity.html#db9bc35ffd8b4c4df8fcd662701ce1a4" title="Called when a new message was received from the associated server.">new_server_message_received</a>(msg);
<a name="l00662"></a>00662       <span class="keywordflow">break</span>;
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664     <span class="keywordflow">default</span>:
<a name="l00665"></a>00665       Dout(dc::warning, <span class="stringliteral">"Unhandled command "</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">" from server"</span>);
<a name="l00666"></a>00666       <a class="code" href="classIdentity.html#5b6ed690dca4101538b7b8e03b3fb3c7" title="Write ServerMessageIn msg to the client.">pass_as_is_to_client</a>(msg);
<a name="l00667"></a>00667       <span class="keywordflow">break</span>;
<a name="l00668"></a>00668   }
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 <span class="comment"></span>
<a name="l00671"></a>00671 <span class="comment">//! Event call back: network domain answer received. Process it.</span>
<a name="l00672"></a><a class="code" href="classIdentity.html#aa0444d422ef667a1c57b9c883b0d3e3">00672</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classIdentity.html#aa0444d422ef667a1c57b9c883b0d3e3" title="Event call back: network domain answer received. Process it.">Identity::received_network_domain_answer</a>(<a class="code" href="classUserAnswerEventType.html" title="The UserAnswer event server&amp;#39;s EventType.">UserAnswerEventType</a> <span class="keyword">const</span>&amp; event_type,
<a name="l00673"></a>00673     std::pair&lt;std::string, std::string&gt; network_domain)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"Identity::received_network_domain_answer("</span> &lt;&lt; event_type);
<a name="l00676"></a>00676   std::string answer = event_type.<a class="code" href="classUserAnswer.html#18a5b3fdd97851d9f102c0a66db45f1b" title="Returns the answer string.">answer</a>();
<a name="l00677"></a>00677   <span class="keywordtype">bool</span> yes = <a class="code" href="IRC__compare_8cc.html#e5bfa2bc25ca9272eb0ec51ad508e369" title="Compare two whole IRC strings in a &amp;#39;case insensitive&amp;#39; way.">IRCStringCompare</a>(answer, <span class="stringliteral">"Yes"</span>) == 0;
<a name="l00678"></a>00678   <span class="keywordtype">bool</span> no = <a class="code" href="IRC__compare_8cc.html#e5bfa2bc25ca9272eb0ec51ad508e369" title="Compare two whole IRC strings in a &amp;#39;case insensitive&amp;#39; way.">IRCStringCompare</a>(answer, <span class="stringliteral">"No"</span>) == 0;
<a name="l00679"></a>00679   <span class="keywordflow">if</span> (!yes &amp;&amp; !no)
<a name="l00680"></a>00680   {
<a name="l00681"></a>00681     std::ostringstream the_question;
<a name="l00682"></a>00682     the_question &lt;&lt; <span class="stringliteral">"Does the "</span> &lt;&lt; network_domain.first &lt;&lt; <span class="stringliteral">" IRC network use \""</span> &lt;&lt;
<a name="l00683"></a>00683         network_domain.second &lt;&lt; <span class="stringliteral">"\" as common domain for all servers (type: Yes|No)?"</span>;
<a name="l00684"></a>00684     <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#c6c444fa618e12e0be321c5e75f20a84" title="The UserAnswer event server.">user_answer_event_server</a>
<a name="l00685"></a>00685         (<a class="code" href="classUserAnswerRequestData.html" title="Request data passed to the event server.">UserAnswerRequestData</a>(<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>(), <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846eb206c8874855d785e917a62c3181851" title="Does this network use s as common domain for all servers (type: Yes | No)?">network_domain_question</a>, the_question.str()),
<a name="l00686"></a>00686         *<span class="keyword">this</span>, &amp;<a class="code" href="classIdentity.html#aa0444d422ef667a1c57b9c883b0d3e3" title="Event call back: network domain answer received. Process it.">Identity::received_network_domain_answer</a>, network_domain);
<a name="l00687"></a>00687   }
<a name="l00688"></a>00688   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (no)
<a name="l00689"></a>00689     <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#924f17d7e20c4ed84a13f2212a52a84a" title="Create a new network object with name network_name and domain domain (if any).">construct_network_object</a>(network_domain.first, <span class="stringliteral">""</span>);
<a name="l00690"></a>00690   <span class="keywordflow">else</span>
<a name="l00691"></a>00691     <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#924f17d7e20c4ed84a13f2212a52a84a" title="Create a new network object with name network_name and domain domain (if any).">construct_network_object</a>(network_domain.first, network_domain.second);
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="preprocessor">#if 0</span><span class="comment"></span>
<a name="l00695"></a>00695 <span class="comment">//! Create a unique (private) target name starting with \a prefix.</span>
<a name="l00696"></a>00696 <span class="comment"></span>std::string Identity::unique_target(char const* prefix) const
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698   std::stringstream result;
<a name="l00699"></a>00699   result &lt;&lt; prefix;
<a name="l00700"></a>00700   ClientSession::private_targets_type::const_iterator iter = <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#077fae5d435ae160b221805648638b4a" title="Return reference to map with private targets.">private_targets</a>().find(result.str());
<a name="l00701"></a>00701   <span class="keywordtype">int</span> postfix = 0;
<a name="l00702"></a>00702   <span class="keywordtype">size_t</span> len = strlen(prefix);
<a name="l00703"></a>00703   <span class="keywordflow">while</span> (iter != <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().private_targets().end())
<a name="l00704"></a>00704   {
<a name="l00705"></a>00705     result.rdbuf()-&gt;pubseekpos(len);
<a name="l00706"></a>00706     result &lt;&lt; <span class="charliteral">'.'</span> &lt;&lt; ++postfix;
<a name="l00707"></a>00707     iter = <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#077fae5d435ae160b221805648638b4a" title="Return reference to map with private targets.">private_targets</a>().find(result.str());
<a name="l00708"></a>00708   }
<a name="l00709"></a>00709   <span class="keywordflow">return</span> result.str();
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 <span class="preprocessor">#endif</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>
<a name="l00713"></a><a class="code" href="classIdentity.html#5ff271e26dd0e344642033db31bd455a">00713</a> boost::shared_ptr&lt;Target&gt; <a class="code" href="classIdentity.html#5ff271e26dd0e344642033db31bd455a" title="Return a target with prefix prefix that is not already in the private network map...">Identity::notice_target</a>(<a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846" title="The different questions that the ircproxy can ask the user.">question_nt</a> number)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715   <span class="keywordtype">char</span> <span class="keyword">const</span>* channel_name;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <span class="keywordflow">if</span> (number != <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb384645b1ad115c41609a80578e43267f4cae" title="For ircproxy notices without related questions.">no_related_question</a>)
<a name="l00718"></a>00718   {
<a name="l00719"></a>00719     channel_name = <a class="code" href="UserAnswer_8cc.html#aae7ee220771f4ad3ecc9ac74c87e7b0" title="Convert question index number into the channel name it belongs to.">question_target_name</a>(number);
<a name="l00720"></a>00720     <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="is__channel_8h.html#9211aa8dc88461be45ad52d918f5782e" title="Returns true if name is a channel name.">is_channel</a>(channel_name));
<a name="l00721"></a>00721   }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723   <span class="keywordflow">while</span>(1)
<a name="l00724"></a>00724   {
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (number == <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb384645b1ad115c41609a80578e43267f4cae" title="For ircproxy notices without related questions.">no_related_question</a>)
<a name="l00726"></a>00726       channel_name = <span class="stringliteral">"&amp;notices"</span>;
<a name="l00727"></a>00727     <span class="comment">// Is the client already joined?</span>
<a name="l00728"></a>00728     ClientSession::private_targets_type::iterator iter = <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#077fae5d435ae160b221805648638b4a" title="Return reference to map with private targets.">private_targets</a>().find(channel_name);
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (iter != <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().private_targets().end())
<a name="l00730"></a>00730       <span class="keywordflow">return</span> iter-&gt;second;
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (number == <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb384645b1ad115c41609a80578e43267f4cae" title="For ircproxy notices without related questions.">no_related_question</a>)
<a name="l00732"></a>00732       <span class="keywordflow">break</span>;
<a name="l00733"></a>00733     number = <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb384645b1ad115c41609a80578e43267f4cae" title="For ircproxy notices without related questions.">no_related_question</a>;
<a name="l00734"></a>00734   }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   <span class="comment">// Create the new NoticeTarget.</span>
<a name="l00737"></a>00737   <a class="code" href="classNoticeTarget.html" title="A fake channel that is used for communication between user and ircproxy.">NoticeTarget</a>* new_notice_target = <span class="keyword">new</span> <a class="code" href="classNoticeTarget.html" title="A fake channel that is used for communication between user and ircproxy.">NoticeTarget</a>(<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>(), channel_name, <a class="code" href="classIdentity.html#076ec46fbabd783e3712179c5b521fb2" title="Fake network, private to this identity.">M_private_network</a>);
<a name="l00738"></a>00738   AllocTag(new_notice_target, channel_name);
<a name="l00739"></a>00739   <span class="comment">// Add it to the private targets map.</span>
<a name="l00740"></a>00740   boost::shared_ptr&lt;Target&gt; private_target(new_notice_target);
<a name="l00741"></a>00741   <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#a9e5f7a673d2a42a98328b55ffa2864e" title="Add target to the private targets list.">add_private_target</a>(private_target);
<a name="l00742"></a>00742   <span class="comment">// Have the client join it.</span>
<a name="l00743"></a>00743   <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>() &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#8f4367fccef8c55504cacbe0191e55ca" title="FIXME.">client_out_nick</a>() &lt;&lt; <span class="stringliteral">" JOIN "</span> &lt;&lt; channel_name &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00744"></a>00744   new_notice_target-&gt;<a class="code" href="classPrivateTarget.html#6fc110a3a167748ea9ff0bd48ab7b40d" title="Generate the NAMES reply for the associated channel.">do_names_output</a>();
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <span class="keywordflow">return</span> private_target;
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 <span class="comment"></span>
<a name="l00749"></a>00749 <span class="comment">//! @brief Send a notice to the client.</span>
<a name="l00750"></a>00750 <span class="comment"></span><span class="comment">//</span>
<a name="l00751"></a>00751 <span class="comment">// Send the string \a notice to the associated client.</span>
<a name="l00752"></a>00752 <span class="comment">// The type \a number of the notice determines the (virtual) channel that will be used for the message.</span>
<a name="l00753"></a><a class="code" href="classIdentity.html#ad20e55e2b6fbe3022e63c3223abae08">00753</a> <span class="keywordtype">void</span> <a class="code" href="classIdentity.html#ad20e55e2b6fbe3022e63c3223abae08" title="Send a notice to the client.">Identity::send_notice</a>(std::string <span class="keyword">const</span>&amp; notice, <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846" title="The different questions that the ircproxy can ask the user.">question_nt</a> number)
<a name="l00754"></a>00754 {
<a name="l00755"></a>00755   *<a class="code" href="classIdentity.html#f1854ef005559a4a7bfa10e0f037e7ec" title="Pointer to the current client session.">M_client_session</a> &lt;&lt; <span class="stringliteral">":Leandro PRIVMSG "</span> &lt;&lt; <a class="code" href="classIdentity.html#5ff271e26dd0e344642033db31bd455a" title="Return a target with prefix prefix that is not already in the private network map...">notice_target</a>(number)-&gt;out_name(*<a class="code" href="classIdentity.html#f1854ef005559a4a7bfa10e0f037e7ec" title="Pointer to the current client session.">M_client_session</a>)  &lt;&lt; <span class="stringliteral">" :"</span> &lt;&lt; notice &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 <span class="comment"></span>
<a name="l00758"></a>00758 <span class="comment">//! @brief Obtain associated server name.</span>
<a name="l00759"></a><a class="code" href="classIdentity.html#44ac5b2b0594d9417659ad191f52bc20">00759</a> <span class="comment"></span>std::string <a class="code" href="classIdentity.html#44ac5b2b0594d9417659ad191f52bc20" title="Return a reasonable servername that can be used as source for client messages.">Identity::server_source</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span>
<a name="l00760"></a>00760 <span class="keyword"></span>{
<a name="l00761"></a>00761   std::string result;
<a name="l00762"></a>00762   <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#b66b41d74f2cce6a8937974eba2f052e" title="Our link to some server.">M_primary_server_connection</a>-&gt;has_server())
<a name="l00763"></a>00763     result = <a class="code" href="classIdentity.html#b66b41d74f2cce6a8937974eba2f052e" title="Our link to some server.">M_primary_server_connection</a>-&gt;server()-&gt;get_irc_name();
<a name="l00764"></a>00764   <span class="keywordflow">if</span> (result.empty())
<a name="l00765"></a>00765     result = <span class="stringliteral">"ircproxy.net"</span>;
<a name="l00766"></a>00766   <span class="keywordflow">return</span> result;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 <span class="comment"></span>
<a name="l00769"></a>00769 <span class="comment">//! @brief Serialize object to XML.</span>
<a name="l00770"></a><a class="code" href="classIdentity.html#472293cfac7d33484b2cdc2895fc9038">00770</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classIdentity.html#472293cfac7d33484b2cdc2895fc9038" title="Serialize the object.">Identity::serialize</a>(<a class="code" href="classPersistXML.html" title="A persistent object archiver.">PersistXML</a>&amp; xml)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772   xml.<a class="code" href="classPersistXML.html#5612c3e53fee8ffb21a228536fea9595" title="Serialize object using the xml tag &amp;lt;label&amp;gt;&amp;lt;/label&amp;gt;.">serialize</a>(<span class="stringliteral">"M_key"</span>, <a class="code" href="classIdentity.html#97c1e362cf7d2b6af2795157fc224dbc" title="The unique identity key as used with the identity map.">M_key</a>);
<a name="l00773"></a>00773   xml.<a class="code" href="classPersistXML.html#5612c3e53fee8ffb21a228536fea9595" title="Serialize object using the xml tag &amp;lt;label&amp;gt;&amp;lt;/label&amp;gt;.">serialize</a>(<span class="stringliteral">"M_authpass"</span>, <a class="code" href="classIdentity.html#1607f2b4aa110ef7b92b07d4daa4cd31" title="Authentication password.">M_authpass</a>);
<a name="l00774"></a>00774   xml.<a class="code" href="classPersistXML.html#5612c3e53fee8ffb21a228536fea9595" title="Serialize object using the xml tag &amp;lt;label&amp;gt;&amp;lt;/label&amp;gt;.">serialize</a>(<span class="stringliteral">"M_network_name"</span>, <a class="code" href="classIdentity.html#4f1fe5439749a78e03086cdfe58a9a6f" title="The network name that corresponds to this identity.">M_network_name</a>);
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00777"></a><a class="code" href="classIdentity.html#e2d2f09e464b093543e398e42669088c">00777</a> <a class="code" href="classIdentity.html#e2d2f09e464b093543e398e42669088c" title="Destruct an Identity.">Identity::~Identity</a>()
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779   Dout(<a class="code" href="namespacedebug_1_1channels_1_1dc.html#4fad4911d56fc2bccbb8ed9041454394" title="This debug channel is used for object construction/destruction tracking.">dc::objects</a>, <span class="stringliteral">"Destructing Identity "</span> &lt;&lt; *<span class="keyword">this</span> &lt;&lt; <span class="stringliteral">"."</span>);
<a name="l00780"></a>00780   <span class="comment">// Destruct channels before destructing private network.</span>
<a name="l00781"></a>00781   <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#b6710a56f4f20332a5b9a10ac8101fb0" title="Return true if this identity is associated with a client session.">has_client_session</a>())
<a name="l00782"></a>00782     <a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#0d0c69d5e0674d086ac4ec09362664b3" title="Return reference to map with known channels.">joined_channels</a>().clear();
<a name="l00783"></a>00783   <span class="keywordflow">if</span> (<a class="code" href="classIdentity.html#07e702de45aded2c55b792c027bff42f" title="Return true if this identity is associated with a server session.">has_server_session</a>())
<a name="l00784"></a>00784     <a class="code" href="classIdentity.html#befd26ceb307699d1b4a16082fa51860" title="Return the current ClientSession.">server_session</a>().<a class="code" href="classServerSession.html#1cdbba5e545c0759814b92d0c578cc02" title="Return reference to map with joined channels.">joined_channels</a>().clear();
<a name="l00785"></a>00785   cancel_all_requests();
<a name="l00786"></a>00786 }
<a name="l00787"></a>00787 
</pre></div></div>
<hr>

<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0>
<TR>
<TH ALIGN=left BGCOLOR="#e8feff"><ADDRESS>Copyright &copy; 2005-2007 Carlo Wood.&nbsp; All rights reserved.</ADDRESS></TH>
</TR>
</TABLE>

</DIV>
</BODY>
</HTML>

