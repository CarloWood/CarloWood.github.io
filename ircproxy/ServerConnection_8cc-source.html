<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML LANG="en-us">
 
<HEAD>
<META name="Author" content="Carlo Wood">
<META name="description" content="IRC proxy">
<META name="keywords" content="IRC, proxy, bnc, security, protection">
<META http-equiv="content-type" content="text/html; charset=iso-8859-1">
<TITLE>ircproxy documentation</TITLE>
<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
<LINK HREF="main.css" REL="stylesheet" TYPE="text/css">
</HEAD>

<BODY>

<TABLE class="header" BORDER=0 CELLSPACING=0 CELLPADDING=0>
<TR>
<TD WIDTH=120><IMG SRC="images/ircproxy.png" BORDER=0></TD>
<TD VALIGN=center ALIGN=center BGCOLOR="#0A0607"><FONT size=+4 color="#ffffff"><B>&nbsp;ircproxy</B>&nbsp;</FONT>
<FONT size=+3 color="#ffffff">The&nbsp;Ultimate&nbsp;Cyborg</FONT></TD>
</TR>
</TABLE>

<DIV class="normal">
<hr>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>ServerConnection.cc</h1><a href="ServerConnection_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// ircproxy -- An IRC bouncer.</span>
<a name="l00002"></a>00002 <span class="comment">//</span><span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">//! @file ServerConnection.cc</span>
<a name="l00004"></a>00004 <span class="comment">//! @brief This file contains the implementation of class ServerConnection.</span>
<a name="l00005"></a>00005 <span class="comment"></span><span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright (C) 2006, 2007 by</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// Carlo Wood, Run on IRC &lt;carlo@alinoe.com&gt;</span>
<a name="l00009"></a>00009 <span class="comment">// RSA-1024 0x624ACAD5 1997-01-26                    Sign &amp; Encrypt</span>
<a name="l00010"></a>00010 <span class="comment">// Fingerprint16 = 32 EC A7 B6 AC DB 65 A6  F6 F6 55 DD 1C DC FF 61</span>
<a name="l00011"></a>00011 <span class="comment">//</span>
<a name="l00012"></a>00012 <span class="comment">// This file may be distributed under the terms of the Q Public License</span>
<a name="l00013"></a>00013 <span class="comment">// version 1.0 as appearing in the file LICENSE.QPL included in the</span>
<a name="l00014"></a>00014 <span class="comment">// packaging of this file.</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#ifndef USE_PCH</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#include "sys.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="debug_8h.html" title="This file contains the declaration of debug related macros, objects and functions...">debug.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#endif</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="ServerConnection_8h.html" title="This file contains the declaration of class ServerConnection.">ServerConnection.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="Identity_8h.html" title="Header of class Identity.">Identity.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="Server_8h.html" title="Header of class Server.">Server.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="UserAnswer_8h.html" title="This file contains the declaration of the UserAnswer events related code.">UserAnswer.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="ClientSession_8h.html" title="This file contains the declaration of class ClientSession.">ClientSession.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "keys.h"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include "<a class="code" href="Authentication_8h.html" title="This file contains the declaration of class Authentication.">Authentication.h</a>"</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="Expression_8h.html" title="This file contains the declaration of Expression related code.">Expression.h</a>"</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="Matcher_8h.html" title="This file contains the declaration of the Matcher classes.">Matcher.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="Bool_8inl.html" title="This file contains the implementation of BoolExpression&amp;lt;inverted&amp;gt;::create_event_server...">Bool.inl</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="Application_8h.html" title="This file contains the declaration of class Application.">Application.h</a>"</span>
<a name="l00034"></a>00034 <span class="comment"></span>
<a name="l00035"></a>00035 <span class="comment">/*! @brief Ordering predicate for Server objects.</span>
<a name="l00036"></a>00036 <span class="comment"> * </span>
<a name="l00037"></a>00037 <span class="comment"> * This struct determines the (re)connect priority of servers.</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a><a class="code" href="structConnectionOrder.html">00039</a> <span class="keyword">struct </span><a class="code" href="structConnectionOrder.html" title="Ordering predicate for Server objects.">ConnectionOrder</a> {
<a name="l00040"></a>00040   <span class="keywordtype">bool</span> operator()(boost::shared_ptr&lt;Server&gt; <span class="keyword">const</span>&amp; server1, boost::shared_ptr&lt;Server&gt; <span class="keyword">const</span>&amp; server2)
<a name="l00041"></a>00041   {
<a name="l00042"></a>00042     timeval <span class="keyword">const</span> now = timerRequest.get_now();
<a name="l00043"></a>00043     timeval <span class="keyword">const</span> ten_minutes = { 600, 0 };
<a name="l00044"></a>00044     timeval ten_minutes_ago;
<a name="l00045"></a>00045     timersub(&amp;now, &amp;ten_minutes, &amp;ten_minutes_ago);
<a name="l00046"></a>00046     <span class="keywordtype">bool</span> server1_more_than_10_minutes_ago = (timercmp(&amp;server1-&gt;last_connection_event(), &amp;ten_minutes_ago, &lt;));
<a name="l00047"></a>00047     <span class="keywordtype">bool</span> server2_more_than_10_minutes_ago = (timercmp(&amp;server2-&gt;last_connection_event(), &amp;ten_minutes_ago, &lt;));
<a name="l00048"></a>00048     <span class="keywordtype">bool</span> server1_longer_ago_than_server2 = (timercmp(&amp;server1-&gt;last_connection_event(), &amp;server2-&gt;last_connection_event(), &lt;));
<a name="l00049"></a>00049     <span class="keywordflow">if</span> (server1_more_than_10_minutes_ago != server2_more_than_10_minutes_ago)
<a name="l00050"></a>00050       <span class="keywordflow">return</span> server1_more_than_10_minutes_ago;
<a name="l00051"></a>00051     <span class="comment">// Always return false if the objects compare equal.</span>
<a name="l00052"></a>00052     <span class="keywordtype">bool</span> different_connection_event = (timercmp(&amp;server1-&gt;last_connection_event(), &amp;server2-&gt;last_connection_event(), !=));
<a name="l00053"></a>00053     <span class="keywordflow">return</span> different_connection_event &amp;&amp; server1_longer_ago_than_server2 != server1_more_than_10_minutes_ago;
<a name="l00054"></a>00054   }
<a name="l00055"></a>00055 };
<a name="l00056"></a>00056 <span class="comment"></span>
<a name="l00057"></a>00057 <span class="comment">/*! @brief Connect to the server and stay connected.</span>
<a name="l00058"></a>00058 <span class="comment"> *</span>
<a name="l00059"></a>00059 <span class="comment"> * This function should be called only after the ServerConnection was just created,</span>
<a name="l00060"></a>00060 <span class="comment"> * or after calling ServerConnection::disconnect.</span>
<a name="l00061"></a>00061 <span class="comment"> *</span>
<a name="l00062"></a>00062 <span class="comment"> * This function will start the procedure of connecting to a server,</span>
<a name="l00063"></a>00063 <span class="comment"> * either the one already specified by ServerConnection::M_server or,</span>
<a name="l00064"></a>00064 <span class="comment"> * if none is known, it will first ask the user for a server name and port.</span>
<a name="l00065"></a>00065 <span class="comment"> *</span>
<a name="l00066"></a>00066 <span class="comment"> * It will continue to attempt to connect to a server (with appropriate</span>
<a name="l00067"></a>00067 <span class="comment"> * connect delays if necessary) until connected. After a connection is successful</span>
<a name="l00068"></a>00068 <span class="comment"> * then the authentication sequence is started (handled by Authentication).</span>
<a name="l00069"></a>00069 <span class="comment"> *</span>
<a name="l00070"></a>00070 <span class="comment"> * If a connection is lost, at any time, then a new connection is automatically</span>
<a name="l00071"></a>00071 <span class="comment"> * attempted.</span>
<a name="l00072"></a>00072 <span class="comment"> */</span>
<a name="l00073"></a><a class="code" href="classServerConnection.html#a5c1bf21b5efcc2b80985b397d3ee57f">00073</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#a5c1bf21b5efcc2b80985b397d3ee57f" title="Connect to the server and stay connected.">ServerConnection::connect</a>(<span class="keywordtype">bool</span> auto_reconnect)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::connect() for "</span> &lt;&lt; *<span class="keyword">this</span>);
<a name="l00076"></a>00076   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!<a class="code" href="classServerConnection.html#8d362234844f0be20b157f1f8d8756e7" title="Return true if we are connected with a server.">is_connected</a>());
<a name="l00077"></a>00077   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2519f950c18a0ec32082cf9984cd2b225" title="Disconnected.">disconnected</a>);
<a name="l00078"></a>00078   <span class="keywordflow">if</span> (!<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>)        <span class="comment">// Could already be allocated if has_server() was false</span>
<a name="l00079"></a>00079                                 <span class="comment">// and we get here a second time because the ClientSession</span>
<a name="l00080"></a>00080                                 <span class="comment">// was destroyed after requesting an answer.</span>
<a name="l00081"></a>00081   {
<a name="l00082"></a>00082     <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> = <span class="keyword">new</span> <a class="code" href="classServerSession.html" title="A server session, from connect till disconnect.">ServerSession</a>(<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>(), *<span class="keyword">this</span>);
<a name="l00083"></a>00083     AllocTag(<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>, (<a class="code" href="classServerConnection.html#c8237a669a8f97c83d51e5bdfd0189cb" title="True if this connection is a secondary connection, while the primary still exists...">M_secondary_connection</a> ? <span class="stringliteral">"Secondary Server session of "</span> : <span class="stringliteral">"Server session of "</span>) &lt;&lt; <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().key());
<a name="l00084"></a>00084   }
<a name="l00085"></a>00085   <span class="keywordflow">if</span> (auto_reconnect)
<a name="l00086"></a>00086   {
<a name="l00087"></a>00087     <span class="comment">// See if we can find a network that this Identity belongs to.</span>
<a name="l00088"></a>00088     <span class="keywordflow">for</span> (networks_type::iterator network_iter = Application::instance().networks().begin(); network_iter != Application::instance().networks().end(); ++network_iter)
<a name="l00089"></a>00089       <span class="keywordflow">if</span> (network_iter-&gt;name() == <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#30cae43d74e1e50408f30d2a3eff2025" title="Returns the network name that this identity corresponds with.">network_name</a>())
<a name="l00090"></a>00090       {
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#5386bd208b67215459af782ab85c4631" title="Return true if we have a server object.">has_server</a>())
<a name="l00092"></a>00092         {
<a name="l00093"></a>00093           <span class="keywordflow">if</span> (!<a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a>)
<a name="l00094"></a>00094           {
<a name="l00095"></a>00095             <a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a> = 3 * network_iter-&gt;servers().size();
<a name="l00096"></a>00096             <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a> != 0);     <span class="comment">// We have at least one server because has_server() is true.</span>
<a name="l00097"></a>00097           }
<a name="l00098"></a>00098           <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#f242a50989467275c426f9e25ad74b6b" title="Set if the last connection attempted timed out.">M_timed_out</a>)
<a name="l00099"></a>00099             --<a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a>;
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101         <span class="keywordflow">if</span> (network_iter-&gt;servers().empty() || (<a class="code" href="classServerConnection.html#f242a50989467275c426f9e25ad74b6b" title="Set if the last connection attempted timed out.">M_timed_out</a> &amp;&amp; !<a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a>))
<a name="l00102"></a>00102           <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>.reset();     <span class="comment">// If we don't have any servers, or when all servers timed out three times on a row.</span>
<a name="l00103"></a>00103         <span class="keywordflow">else</span>
<a name="l00104"></a>00104         {
<a name="l00105"></a>00105           std::stable_sort(network_iter-&gt;servers().begin(), network_iter-&gt;servers().end(), <a class="code" href="structConnectionOrder.html" title="Ordering predicate for Server objects.">ConnectionOrder</a>());
<a name="l00106"></a>00106           <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a> = network_iter-&gt;servers().front();
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108         <span class="keywordflow">break</span>;
<a name="l00109"></a>00109       }
<a name="l00110"></a>00110   }
<a name="l00111"></a>00111   <a class="code" href="classServerConnection.html#da968ead31fd07d9964f251530cc81d3" title="True if we should try to (re)connect.">M_reconnect</a> = <span class="keyword">true</span>;
<a name="l00112"></a>00112   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#5386bd208b67215459af782ab85c4631" title="Return true if we have a server object.">has_server</a>())
<a name="l00113"></a>00113   {
<a name="l00114"></a>00114     timeval next_connect;
<a name="l00115"></a>00115     timeradd(&amp;<a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;last_connection_event(), &amp;<a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>, &amp;next_connect);
<a name="l00116"></a>00116     timeval now = timerRequest.get_now();
<a name="l00117"></a>00117     <span class="keywordflow">if</span> (timercmp(&amp;now, &amp;next_connect, &gt;))
<a name="l00118"></a>00118       <a class="code" href="classServerConnection.html#0bb470a3215a2780f846e806897359c5" title="Attempt an immediate connect to the server.">do_connect</a>();
<a name="l00119"></a>00119     <span class="keywordflow">else</span>
<a name="l00120"></a>00120       timerRequest(<a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>, *<span class="keyword">this</span>, &amp;<a class="code" href="classServerConnection.html#8107012a4c7d6b008c1d9401f78851f1" title="Called when the timer for a delayed connect expired.">ServerConnection::delayed_connect</a>);
<a name="l00121"></a>00121   }
<a name="l00122"></a>00122   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().has_client_session())
<a name="l00123"></a>00123   {
<a name="l00124"></a>00124     <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!<a class="code" href="classServerConnection.html#c8237a669a8f97c83d51e5bdfd0189cb" title="True if this connection is a secondary connection, while the primary still exists...">M_secondary_connection</a>);    <span class="comment">// The secondary connection should always have a server.</span>
<a name="l00125"></a>00125     <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#c6c444fa618e12e0be321c5e75f20a84" title="The UserAnswer event server.">user_answer_event_server</a>
<a name="l00126"></a>00126         (<a class="code" href="classUserAnswerRequestData.html" title="Request data passed to the event server.">UserAnswerRequestData</a>(<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().client_session(), <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846bb516cb7284441ea7de98a9408a8351f" title="What server should I connect to (type: &amp;lt;server&amp;gt; [&amp;lt;port&amp;gt; [&amp;lt;localip&amp;gt;]])...">server_port_question</a>,
<a name="l00127"></a>00127         <span class="stringliteral">"What server should I connect to (type: &lt;server&gt; [&lt;port&gt; [&lt;localip&gt;]])?"</span>),
<a name="l00128"></a>00128         *<span class="keyword">this</span>, &amp;<a class="code" href="classServerConnection.html#f7186fd0672f082a283600406f86fd1b" title="This function is called when an answer to the server/port question is received.">ServerConnection::received_server_port_answer</a>);
<a name="l00129"></a>00129   }
<a name="l00130"></a>00130   <span class="keywordflow">else</span>
<a name="l00131"></a>00131     <a class="code" href="classServerConnection.html#00dd03d4df481351061cafa48f74b6ed" title="Disconnect from the server.">disconnect</a>();
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 <span class="comment"></span>
<a name="l00134"></a>00134 <span class="comment">/*! @brief Called when the timer for a delayed connect expired.</span>
<a name="l00135"></a>00135 <span class="comment"> *</span>
<a name="l00136"></a>00136 <span class="comment"> * Never call this function directly.</span>
<a name="l00137"></a>00137 <span class="comment"> */</span>
<a name="l00138"></a><a class="code" href="classServerConnection.html#8107012a4c7d6b008c1d9401f78851f1">00138</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#8107012a4c7d6b008c1d9401f78851f1" title="Called when the timer for a delayed connect expired.">ServerConnection::delayed_connect</a>(timer_event_type_ct <span class="keyword">const</span>&amp; LIBCW_UNUSED_UNLESS_DEBUG(expired_at))
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::delayed_connect("</span> &lt;&lt; expired_at.get_expire_time() &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00141"></a>00141   <span class="keywordflow">if</span> (!<a class="code" href="classServerConnection.html#8d362234844f0be20b157f1f8d8756e7" title="Return true if we are connected with a server.">is_connected</a>() &amp;&amp; <a class="code" href="classServerConnection.html#da968ead31fd07d9964f251530cc81d3" title="True if we should try to (re)connect.">M_reconnect</a> &amp;&amp; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &amp;&amp; <a class="code" href="classServerConnection.html#5386bd208b67215459af782ab85c4631" title="Return true if we have a server object.">has_server</a>())
<a name="l00142"></a>00142     <a class="code" href="classServerConnection.html#0bb470a3215a2780f846e806897359c5" title="Attempt an immediate connect to the server.">do_connect</a>();
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">/*! @brief Attempt an immediate connect to the server.</span>
<a name="l00146"></a>00146 <span class="comment"> *</span>
<a name="l00147"></a>00147 <span class="comment"> * Never call this function directly. Call ServerConnection::connect() instead.</span>
<a name="l00148"></a>00148 <span class="comment"> */</span>
<a name="l00149"></a><a class="code" href="classServerConnection.html#0bb470a3215a2780f846e806897359c5">00149</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#0bb470a3215a2780f846e806897359c5" title="Attempt an immediate connect to the server.">ServerConnection::do_connect</a>(<span class="keywordtype">void</span>)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::do_connect()"</span>);
<a name="l00152"></a>00152   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2519f950c18a0ec32082cf9984cd2b225" title="Disconnected.">disconnected</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <span class="keywordflow">if</span> (<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().has_client_session())
<a name="l00155"></a>00155   {
<a name="l00156"></a>00156     std::ostringstream buf;
<a name="l00157"></a>00157     buf &lt;&lt; <span class="stringliteral">"Trying to connect to \""</span> &lt;&lt; <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;hostname().c_str() &lt;&lt; <span class="stringliteral">"\" (port "</span> &lt;&lt; <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;next_port() &lt;&lt; <span class="stringliteral">")."</span>;
<a name="l00158"></a>00158     <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#ad20e55e2b6fbe3022e63c3223abae08" title="Send a notice to the client.">send_notice</a>(buf.str(), <a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846bb516cb7284441ea7de98a9408a8351f" title="What server should I connect to (type: &amp;lt;server&amp;gt; [&amp;lt;port&amp;gt; [&amp;lt;localip&amp;gt;]])...">server_port_question</a>);
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="comment">// Reset the timed_out flag.</span>
<a name="l00162"></a>00162   <a class="code" href="classServerConnection.html#f242a50989467275c426f9e25ad74b6b" title="Set if the last connection attempted timed out.">M_timed_out</a> = <span class="keyword">false</span>;
<a name="l00163"></a>00163   <span class="comment">// Set new time out timer.</span>
<a name="l00164"></a>00164   timeval delay = { 4, 0 };
<a name="l00165"></a>00165   timerRequest(delay, *<span class="keyword">this</span>, &amp;ServerConnection::connect_timed_out);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;next_port() != 0);
<a name="l00168"></a>00168   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;connect(<a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;hostname().c_str(), <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;next_port(), <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;vhost()))
<a name="l00169"></a>00169   {
<a name="l00170"></a>00170     <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;attempting_to_connect();
<a name="l00171"></a>00171     <a class="code" href="classServerConnection.html#a0d3f683f7af15bbc0a84203bde206b9">M_connected</a> = <span class="keyword">true</span>;
<a name="l00172"></a>00172     <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#b5e541da0e832562f5bf104ae2973a6e" title="Called from ServerConnection::do_connect. Takes care of sending PASS/NICK/USER/PONG/MODE...">start_authentication</a>();
<a name="l00173"></a>00173     <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> = <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef257f508eceda8432c9eab0643f0e6346d" title="PASS, NICK and USER message sent.">authentication_started</a>;
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175   <span class="keywordflow">else</span>
<a name="l00176"></a>00176   {
<a name="l00177"></a>00177     <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!<a class="code" href="classServerConnection.html#c8237a669a8f97c83d51e5bdfd0189cb" title="True if this connection is a secondary connection, while the primary still exists...">M_secondary_connection</a>);    <span class="comment">// FIXME</span>
<a name="l00178"></a>00178     <span class="comment">// If the connect failed, then we have to ask the user for another servername.</span>
<a name="l00179"></a>00179     <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>.reset();
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().has_client_session())
<a name="l00181"></a>00181       <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#488ed5623c5661d68bf7a80825a53897" title="Remove target_name from the private targets list.">del_private_target</a>(<a class="code" href="UserAnswer_8cc.html#aae7ee220771f4ad3ecc9ac74c87e7b0" title="Convert question index number into the channel name it belongs to.">question_target_name</a>(<a class="code" href="question__nt_8h.html#027b743250267c94e5a1a63e0bbb3846bb516cb7284441ea7de98a9408a8351f" title="What server should I connect to (type: &amp;lt;server&amp;gt; [&amp;lt;port&amp;gt; [&amp;lt;localip&amp;gt;]])...">server_port_question</a>));
<a name="l00182"></a>00182     <span class="comment">// Try again.</span>
<a name="l00183"></a>00183     <a class="code" href="classServerConnection.html#a5c1bf21b5efcc2b80985b397d3ee57f" title="Connect to the server and stay connected.">connect</a>(<span class="keyword">true</span>);
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="keywordtype">void</span> ServerConnection::connect_timed_out(timer_event_type_ct <span class="keyword">const</span>&amp; LIBCW_UNUSED_UNLESS_DEBUG(expired_at))
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> &gt; <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef257f508eceda8432c9eab0643f0e6346d" title="PASS, NICK and USER message sent.">authentication_started</a>) <span class="comment">// Connection was (already) successful?</span>
<a name="l00190"></a>00190     <span class="keywordflow">return</span>;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::connect_timed_out("</span> &lt;&lt; expired_at.get_expire_time() &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00193"></a>00193   <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;close();
<a name="l00194"></a>00194   <a class="code" href="classServerConnection.html#f242a50989467275c426f9e25ad74b6b" title="Set if the last connection attempted timed out.">M_timed_out</a> = <span class="keyword">true</span>;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">/*! @brief This function is called when an answer to the server/port question is received.</span>
<a name="l00198"></a>00198 <span class="comment"> *</span>
<a name="l00199"></a>00199 <span class="comment"> * Never call this function directly.</span>
<a name="l00200"></a>00200 <span class="comment"> */</span>
<a name="l00201"></a><a class="code" href="classServerConnection.html#f7186fd0672f082a283600406f86fd1b">00201</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#f7186fd0672f082a283600406f86fd1b" title="This function is called when an answer to the server/port question is received.">ServerConnection::received_server_port_answer</a>(<a class="code" href="classUserAnswerEventType.html" title="The UserAnswer event server&amp;#39;s EventType.">UserAnswerEventType</a> <span class="keyword">const</span>&amp; event_type)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::received_server_port_answer("</span> &lt;&lt; event_type &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00204"></a>00204   std::string answer = event_type.<a class="code" href="classUserAnswer.html#18a5b3fdd97851d9f102c0a66db45f1b" title="Returns the answer string.">answer</a>();
<a name="l00205"></a>00205   std::string hostname;
<a name="l00206"></a>00206   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> port = 6667;
<a name="l00207"></a>00207   <span class="keyword">struct </span>in_addr vhost = { INADDR_ANY };
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count = 0;
<a name="l00210"></a>00210   std::stringstream ss(answer);
<a name="l00211"></a>00211   std::string buf;
<a name="l00212"></a>00212   <span class="keywordflow">while</span> ((ss &gt;&gt; buf))
<a name="l00213"></a>00213   {
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (count == 0)
<a name="l00215"></a>00215       hostname = buf;
<a name="l00216"></a>00216     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count == 1)
<a name="l00217"></a>00217       port = atoi(buf.c_str());
<a name="l00218"></a>00218     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count == 2)
<a name="l00219"></a>00219       inet_aton(buf.c_str(), &amp;vhost);
<a name="l00220"></a>00220     ++count;
<a name="l00221"></a>00221   }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="comment">// See if this server was already known.</span>
<a name="l00224"></a>00224   <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l00225"></a>00225   <span class="keywordflow">for</span> (networks_type::iterator network_iter = Application::instance().networks().begin(); network_iter != Application::instance().networks().end(); ++network_iter)
<a name="l00226"></a>00226   {
<a name="l00227"></a>00227     <span class="comment">// Never change network.</span>
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#5386bd208b67215459af782ab85c4631" title="Return true if we have a server object.">has_server</a>() &amp;&amp; <a class="code" href="classServerConnection.html#c31da41babaae4b0f781f6e6f1e177ad" title="Returns the server that we are connected with or connecting to.">server</a>()-&gt;network().name() != network_iter-&gt;name())
<a name="l00229"></a>00229       <span class="keywordflow">continue</span>;
<a name="l00230"></a>00230     <span class="keywordflow">for</span> (Network::servers_type::iterator server_iter = network_iter-&gt;servers().begin(); server_iter != network_iter-&gt;servers().end(); ++server_iter)
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (strcasecmp((*server_iter)-&gt;hostname().c_str(), hostname.c_str()) == 0 &amp;&amp; memcmp(&amp;(*server_iter)-&gt;vhost(), &amp;vhost, <span class="keyword">sizeof</span>(vhost)) == 0)
<a name="l00232"></a>00232       {
<a name="l00233"></a>00233         Dout(dc::notice, <span class="stringliteral">"Found existing server "</span> &lt;&lt; *server_iter);
<a name="l00234"></a>00234         found = <span class="keyword">true</span>;
<a name="l00235"></a>00235         <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a> = *server_iter;
<a name="l00236"></a>00236         <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;set_port(port);
<a name="l00237"></a>00237         <span class="keywordflow">break</span>;
<a name="l00238"></a>00238       }
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (found)
<a name="l00240"></a>00240       <span class="keywordflow">break</span>;
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242   <span class="keywordflow">if</span> (!found)
<a name="l00243"></a>00243     <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>.reset(NEW(<a class="code" href="classServer.html" title="An IRC server.">Server</a>(<a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().private_network(), hostname, port, vhost)));
<a name="l00244"></a>00244   <a class="code" href="classServerConnection.html#f242a50989467275c426f9e25ad74b6b" title="Set if the last connection attempted timed out.">M_timed_out</a> = <span class="keyword">false</span>;
<a name="l00245"></a>00245   <a class="code" href="classServerConnection.html#a5c1bf21b5efcc2b80985b397d3ee57f" title="Connect to the server and stay connected.">connect</a>(<span class="keyword">false</span>);
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 <span class="comment"></span>
<a name="l00248"></a>00248 <span class="comment">/*! @brief This function is called when the ServerSession object is destroyed.</span>
<a name="l00249"></a>00249 <span class="comment"> *</span>
<a name="l00250"></a>00250 <span class="comment"> * Never call this function directly.</span>
<a name="l00251"></a>00251 <span class="comment"> */</span>
<a name="l00252"></a><a class="code" href="classServerConnection.html#4cb8d6fa95cdc9a4042978d5f290b1b7">00252</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#4cb8d6fa95cdc9a4042978d5f290b1b7" title="This function is called when the ServerSession object is destroyed.">ServerConnection::session_lost</a>(<span class="keywordtype">void</span>)
<a name="l00253"></a>00253 { 
<a name="l00254"></a>00254   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> != <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2519f950c18a0ec32082cf9984cd2b225" title="Disconnected.">disconnected</a>)
<a name="l00255"></a>00255   {
<a name="l00256"></a>00256     <span class="comment">// Inform the server object.</span>
<a name="l00257"></a>00257     <a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;connection_lost();
<a name="l00258"></a>00258     <span class="comment">// Let the client know that the connection was broken.</span>
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (!<a class="code" href="classServerConnection.html#c8237a669a8f97c83d51e5bdfd0189cb" title="True if this connection is a secondary connection, while the primary still exists...">M_secondary_connection</a> &amp;&amp; <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().has_client_session())
<a name="l00260"></a>00260       <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#4cd26e4bddc74ee29d48d62eb36998ec" title="Return the current ClientSession.">client_session</a>().<a class="code" href="classClientSession.html#f33264c0e0add56fbe88630c41a23aee" title="This function is called from ServerSession::session_lost().">serversession_lost</a>();
<a name="l00261"></a>00261   }
<a name="l00262"></a>00262   <a class="code" href="classServerConnection.html#a0d3f683f7af15bbc0a84203bde206b9">M_connected</a> = <span class="keyword">false</span>;
<a name="l00263"></a>00263   <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> = <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2519f950c18a0ec32082cf9984cd2b225" title="Disconnected.">disconnected</a>;
<a name="l00264"></a>00264   <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> = NULL;
<a name="l00265"></a>00265   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#c8237a669a8f97c83d51e5bdfd0189cb" title="True if this connection is a secondary connection, while the primary still exists...">M_secondary_connection</a>)
<a name="l00266"></a>00266   {
<a name="l00267"></a>00267     <a class="code" href="classServerConnection.html#da968ead31fd07d9964f251530cc81d3" title="True if we should try to (re)connect.">M_reconnect</a> = <span class="keyword">false</span>;
<a name="l00268"></a>00268     <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#ccac348b8786786a5af3b5a9dcbf9e21">destroy_secondary_server_connection</a>();
<a name="l00269"></a>00269   }
<a name="l00270"></a>00270   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#da968ead31fd07d9964f251530cc81d3" title="True if we should try to (re)connect.">M_reconnect</a>)
<a name="l00271"></a>00271     <a class="code" href="classServerConnection.html#a5c1bf21b5efcc2b80985b397d3ee57f" title="Connect to the server and stay connected.">connect</a>(<span class="keyword">true</span>);
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">// Initial/minimal reconnect delay is 1 second.</span>
<a name="l00275"></a>00275 timeval <a class="code" href="classServerConnection.html#119910e5efed5d10039adf7f13fb1167" title="The initial connect delay.">ServerConnection::S_connect_delay_init</a> = { 1, 0 };
<a name="l00276"></a>00276 <span class="comment"></span>
<a name="l00277"></a>00277 <span class="comment">/*! @brief This function is called if an ERROR message is received.</span>
<a name="l00278"></a>00278 <span class="comment"> *</span>
<a name="l00279"></a>00279 <span class="comment"> * Never call this function directly.</span>
<a name="l00280"></a>00280 <span class="comment"> */</span>
<a name="l00281"></a><a class="code" href="classServerConnection.html#2779cc22d1b308d478c74fd4105d8ec3">00281</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#2779cc22d1b308d478c74fd4105d8ec3" title="This function is called if an ERROR message is received.">ServerConnection::error_message_received</a>(<a class="code" href="classServerMessageIn.html" title="An IRC message as received from a server.">ServerMessageIn</a> <span class="keyword">const</span>&amp; msg)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::notice, <span class="stringliteral">"ServerConnection::error_message_received("</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285   <a class="code" href="classServerConnection.html#832a5728134205d1bcd2ef367b136c04" title="Return the ServerSession.">server_session</a>().<a class="code" href="classServerSession.html#107a2150c039e369b50ee3ffe1809457" title="Set the disconnect reason to disconnect_reason.">set_disconnect_reason</a>(msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> &lt; <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef220561b24714ed87425f7d797a83f1f78" title="Received first server message.">successful_connect</a>)
<a name="l00288"></a>00288   {
<a name="l00289"></a>00289     <span class="comment">// FIXME: only do this when the connection was throttled.</span>
<a name="l00290"></a>00290     <span class="comment">// Different actions are needed on different errors.</span>
<a name="l00291"></a>00291     <a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>.tv_sec *= 2;  
<a name="l00292"></a>00292     <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>.tv_sec &gt; 600)
<a name="l00293"></a>00293       <a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>.tv_sec = 600;
<a name="l00294"></a>00294     Dout(dc::notice, <span class="stringliteral">"Incrementing connect delay to "</span> &lt;&lt; <a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a>);
<a name="l00295"></a>00295   }
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 <span class="comment"></span>
<a name="l00298"></a>00298 <span class="comment">/*! @brief Called when the first message is received from the server.</span>
<a name="l00299"></a>00299 <span class="comment"> */</span>
<a name="l00300"></a><a class="code" href="classServerConnection.html#5b7a006c3d2be22e831a6e29b054592c">00300</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#5b7a006c3d2be22e831a6e29b054592c" title="Called when the first message is received from the server.">ServerConnection::successful_connection</a>(<span class="keywordtype">void</span>)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef257f508eceda8432c9eab0643f0e6346d" title="PASS, NICK and USER message sent.">authentication_started</a> || <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef220561b24714ed87425f7d797a83f1f78" title="Received first server message.">successful_connect</a>);
<a name="l00303"></a>00303   <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> = <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef220561b24714ed87425f7d797a83f1f78" title="Received first server message.">successful_connect</a>;
<a name="l00304"></a>00304   <a class="code" href="classServerConnection.html#0bd8fa9e9cfbfae860406eae4b270885" title="The next connect delay.">M_connect_delay</a> = <a class="code" href="classServerConnection.html#119910e5efed5d10039adf7f13fb1167" title="The initial connect delay.">S_connect_delay_init</a>;       <span class="comment">// We didn't get throttled.</span>
<a name="l00305"></a>00305   <a class="code" href="classServerConnection.html#325de08b35f8b26eaea50b2edb0c4c36" title="The number of connect attempts left that will time out, until we stop trying.">M_timed_out_count</a> = 0;
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">/*! @brief This function is called when a PING message is received.</span>
<a name="l00309"></a>00309 <span class="comment"> *</span>
<a name="l00310"></a>00310 <span class="comment"> * Never call this function directly.</span>
<a name="l00311"></a>00311 <span class="comment"> */</span>
<a name="l00312"></a><a class="code" href="classServerConnection.html#61f1caf7c83a2bdef5d6d75968754fcd">00312</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#61f1caf7c83a2bdef5d6d75968754fcd" title="This function is called when a PING message is received.">ServerConnection::decode_ping</a>(<a class="code" href="classServerMessageIn.html" title="An IRC message as received from a server.">ServerMessageIn</a> <span class="keyword">const</span>&amp; ping_msg)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> &gt;= <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef23fcdc806883284d1121056468515dc4d" title="NICK with real nick name sent.">real_nick_sent</a>)
<a name="l00315"></a>00315   {
<a name="l00316"></a>00316     <a class="code" href="classMessageOut.html" title="An output message.">MessageOut</a> msgout(<a class="code" href="Priority_8cc.html#18032271e548be4e8a0bacc13c4785f0" title="Return the default priority for command.">default_priority</a>(keys::PONG));
<a name="l00317"></a>00317     <a class="code" href="classServerConnection.html#832a5728134205d1bcd2ef367b136c04" title="Return the ServerSession.">server_session</a>().<a class="code" href="classServerSession.html#6921a52d4541f22dc13cf48b743baf19" title="Queue message msg.">queue_msg</a>(msgout &lt;&lt; keys::PONG &lt;&lt; ping_msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00318"></a>00318   }
<a name="l00319"></a>00319   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> &gt;= <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2e329594b1df5c5307e5e5126edb1d605" title="PONG and MODE +i sent.">pong_sent</a>)
<a name="l00320"></a>00320     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"PONG "</span> &lt;&lt; ping_msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0) &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00321"></a>00321   <span class="keywordflow">else</span>
<a name="l00322"></a>00322   {
<a name="l00323"></a>00323     <a class="code" href="classServerConnection.html#5b7a006c3d2be22e831a6e29b054592c" title="Called when the first message is received from the server.">successful_connection</a>();
<a name="l00324"></a>00324     <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#007e71fd0ebc59b15455cf7cfc73acd3" title="Called from ServerConnection::decode_ping with the argument of the first PING.">set_auth_ping_argument</a>(ping_msg.<a class="code" href="classMessageIn.html#0d6e087c8bc7e3a3051eed974ba6ddbb" title="Returns parameter n as a std::string. The result is empty if there no such parameter...">param</a>(0));
<a name="l00325"></a>00325   }
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 <span class="comment"></span>
<a name="l00328"></a>00328 <span class="comment">/*! @brief This function is called when it is safe to call it.</span>
<a name="l00329"></a>00329 <span class="comment"> *</span>
<a name="l00330"></a>00330 <span class="comment"> * See AuthState::AuthState.</span>
<a name="l00331"></a>00331 <span class="comment"> * Never call this function directly.</span>
<a name="l00332"></a>00332 <span class="comment"> */</span>
<a name="l00333"></a><a class="code" href="classServerConnection.html#5d35def1ca0c87f06ba7d7f685f64e72">00333</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#5d35def1ca0c87f06ba7d7f685f64e72" title="This function is called when it is safe to call it.">ServerConnection::send_pong_and_mode</a>(<a class="code" href="classExpressionEventType.html" title="The EventType for Expression&amp;#39;s.">ExpressionEventType</a> <span class="keyword">const</span>&amp; LIBCW_UNUSED_UNLESS_DEBUG(event_type))
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::notice, <span class="stringliteral">"ServerConnection::send_pong_and_mode("</span> &lt;&lt; event_type &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef220561b24714ed87425f7d797a83f1f78" title="Received first server message.">successful_connect</a>);                        <span class="comment">// We received at least the PING.</span>
<a name="l00338"></a>00338   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(!<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#a194c92493a43f5c86d79eb5ea8e9c27" title="Return argument of the first PING.">auth_ping_argument</a>().empty());      <span class="comment">// Didn't we?</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340   *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"PONG "</span> &lt;&lt; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#a194c92493a43f5c86d79eb5ea8e9c27" title="Return argument of the first PING.">auth_ping_argument</a>() &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00341"></a>00341   <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> = <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2e329594b1df5c5307e5e5126edb1d605" title="PONG and MODE +i sent.">pong_sent</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="comment">// Send the 'invisible' user mode in the same packet as the PONG, in the hope</span>
<a name="l00344"></a>00344   <span class="comment">// that the server will process them at the same time. That way we are not</span>
<a name="l00345"></a>00345   <span class="comment">// (for 2 seconds) visible to the network.</span>
<a name="l00346"></a>00346   <span class="comment">// Thus, we will have sent [PASS], NICK, USER, PONG, MODE +i -- which should</span>
<a name="l00347"></a>00347   <span class="comment">// be processed immediately (we have 5 free messages before the flood protection</span>
<a name="l00348"></a>00348   <span class="comment">// kicks in).</span>
<a name="l00349"></a>00349   <span class="keywordtype">char</span> service_mode = <span class="charliteral">'x'</span>;      <span class="comment">// FIXME, this isn't the same on every network.</span>
<a name="l00350"></a>00350   <span class="comment">// If we don't know if the USER did set the user mode, ask for the user mode to see if it did.</span>
<a name="l00351"></a>00351   <span class="comment">// Always sent the +i to assure invisibility at the same time as the PONG is</span>
<a name="l00352"></a>00352   <span class="comment">// processed.</span>
<a name="l00353"></a>00353   <span class="keywordflow">if</span> (!<a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;version().get_user_supports_umode())
<a name="l00354"></a>00354   {
<a name="l00355"></a>00355     <span class="comment">// Always set invisibility.</span>
<a name="l00356"></a>00356     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"MODE "</span> &lt;&lt; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#3b35892ac9ec3e9b7a8c5354675da03f" title="Returns the last NICK sent.">out_nick</a>() &lt;&lt; <span class="stringliteral">" +i\r\n"</span>;
<a name="l00357"></a>00357     <span class="comment">// Test.</span>
<a name="l00358"></a>00358     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"MODE "</span> &lt;&lt; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#3b35892ac9ec3e9b7a8c5354675da03f" title="Returns the last NICK sent.">out_nick</a>() &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00359"></a>00359     <span class="comment">// Finish.</span>
<a name="l00360"></a>00360     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"MODE "</span> &lt;&lt; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#3b35892ac9ec3e9b7a8c5354675da03f" title="Returns the last NICK sent.">out_nick</a>() &lt;&lt; <span class="stringliteral">" +"</span> &lt;&lt; service_mode &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!*<a class="code" href="classServerConnection.html#32cfadcb86d87c251daca5574a492834" title="The server that we are connected to or trying to connect to, or NULL when the server...">M_server</a>-&gt;version().get_user_supports_umode())
<a name="l00363"></a>00363     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"MODE "</span> &lt;&lt; <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#3bf7aaaf37f650ecae8ede46fddb06e6" title="Server session nick pair.">nicks</a>().<a class="code" href="classNickPair.html#3b35892ac9ec3e9b7a8c5354675da03f" title="Returns the last NICK sent.">out_nick</a>() &lt;&lt; <span class="stringliteral">" +i"</span> &lt;&lt; service_mode &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <a class="code" href="classConstExpression.html" title="An expression consisting of a constant.">ConstExpression&lt;UserModeMask&gt;</a> mask(<a class="code" href="structUserModeMask.html">UserModeMask</a>(<span class="charliteral">'i'</span>) | service_mode);
<a name="l00366"></a>00366   ON_TRUE((*<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#eb14b6156420f8413e9d3e905688783d" title="Return my user mode.">user_mode</a>() &amp; mask) == mask &amp;&amp; *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#ff50b0591d529f0a69d9c9f05695f716" title="True if the network is fully detected.">M_detected_network</a>, *<span class="keyword">this</span>, &amp;<a class="code" href="classServerConnection.html#4c6cc9ba1f2ebf73e0173d00df30cac3" title="Called when we first turn invisible.">ServerConnection::invisible_event</a>);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <a class="code" href="classMatchRequest.html" title="A match request.">MatchRequest</a> match_request;
<a name="l00369"></a>00369   match_request(keys::MODE).<a class="code" href="classMatchRequest.html#b5ca0d5cb18fa48ce6ce3b9beaa480c4" title="Request a match if parameter param contains our nick name.">mynick</a>(0);
<a name="l00370"></a>00370   <a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>-&gt;<a class="code" href="classServerSession.html#8fc297dda17c13decc4906f165d2de19" title="Return a reference to the event server for incoming messages.">message_event_server</a>()(match_request, *<span class="keyword">this</span>, &amp;<a class="code" href="classServerConnection.html#f8258e3de592f47fab265f0d1a0abd44" title="Called for the first MODE &amp;lt;mynick&amp;gt; received from the server.">ServerConnection::received_first_umode</a>);
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 <span class="comment"></span>
<a name="l00373"></a>00373 <span class="comment">/*! @brief This function is called when MODE +i is received.</span>
<a name="l00374"></a>00374 <span class="comment"> *</span>
<a name="l00375"></a>00375 <span class="comment"> * Never call this function directly.</span>
<a name="l00376"></a>00376 <span class="comment"> */</span>
<a name="l00377"></a><a class="code" href="classServerConnection.html#4c6cc9ba1f2ebf73e0173d00df30cac3">00377</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#4c6cc9ba1f2ebf73e0173d00df30cac3" title="Called when we first turn invisible.">ServerConnection::invisible_event</a>(<a class="code" href="classExpressionEventType.html" title="The EventType for Expression&amp;#39;s.">ExpressionEventType</a> <span class="keyword">const</span>&amp; LIBCW_UNUSED_UNLESS_DEBUG(event_type))
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::notice, <span class="stringliteral">"ServerConnection::invisible_event("</span> &lt;&lt; event_type &lt;&lt; <span class="charliteral">')'</span>);
<a name="l00380"></a>00380   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(event_type);   <span class="comment">// It should be true, of course.</span>
<a name="l00381"></a>00381   
<a name="l00382"></a>00382   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(<a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> == <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef2e329594b1df5c5307e5e5126edb1d605" title="PONG and MODE +i sent.">pong_sent</a>);
<a name="l00383"></a>00383   <a class="code" href="classServerConnection.html#8ee9481e0fce407147dc1b3a0a6afbea" title="The state of the connection.">M_state</a> = <a class="code" href="ServerConnection_8h.html#8bd3e377b5e0da0a7d154425796c9ef27fedf7842abd845d06c188fc73e5775b" title="Login message to X sent.">login_sent</a>;
<a name="l00384"></a>00384   *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"PRIVMSG X@channels.undernet.org :login "</span> &lt;&lt;
<a name="l00385"></a>00385       <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#0cfb4a50c8b09d335de9f268aa1fc5de" title="The key of this Identity.">key</a>() &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#b94224aa9917eafb7885d0411cf4bfd9" title="Return the authentication object.">authentication</a>().<a class="code" href="classAuthentication.html#8d36f4697dab1354c0033cdf01b40f0b" title="Return the Service password (used to login into X, for example).">service_pass</a>() &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 <span class="comment"></span>
<a name="l00388"></a>00388 <span class="comment">/*! @brief Called for the first MODE &amp;lt;mynick&amp;gt; received from the server.</span>
<a name="l00389"></a>00389 <span class="comment"> *</span>
<a name="l00390"></a>00390 <span class="comment"> * This call-back is used to extract the real ident and real hostname, as the IRC server sees it.</span>
<a name="l00391"></a>00391 <span class="comment"> */</span>
<a name="l00392"></a><a class="code" href="classServerConnection.html#f8258e3de592f47fab265f0d1a0abd44">00392</a> <span class="keywordtype">void</span> <a class="code" href="classServerConnection.html#f8258e3de592f47fab265f0d1a0abd44" title="Called for the first MODE &amp;lt;mynick&amp;gt; received from the server.">ServerConnection::received_first_umode</a>(<a class="code" href="classMatcherEventType.html" title="The type of the argument that is returned with the callback.">MatcherEventType</a> <span class="keyword">const</span>&amp; event_type)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394   <a class="code" href="debug_8h.html#3dc350a548c074386c3ec0271d16a7a8" title="Debugging macro.">DoutEntering</a>(dc::debug, <span class="stringliteral">"ServerConnection::received_first_umode("</span> &lt;&lt; event_type &lt;&lt; <span class="stringliteral">")"</span>);
<a name="l00395"></a>00395   <a class="code" href="classMessageIn_1_1Part.html" title="Part of an MessageIn.">MessageIn::Part</a> <span class="keyword">const</span>&amp; prefix(event_type.<a class="code" href="classMatcherEventType.html#3d17ad6fea1a67344c9c799d1a642b62" title="Accessor.">message</a>().<a class="code" href="classMessageIn.html#093cd417cb0206413eee0f2302579586" title="The prefix. The returned Part is only valid as long as the MessageIn is not destructed...">prefix_part</a>());
<a name="l00396"></a>00396   <span class="keywordtype">char</span> <span class="keyword">const</span>* p = strchr(prefix.start(), <span class="charliteral">'!'</span>);
<a name="l00397"></a>00397   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(p);
<a name="l00398"></a>00398   <span class="keywordtype">char</span> <span class="keyword">const</span>* ident = p + 1;
<a name="l00399"></a>00399   p = strchr(p, <span class="charliteral">'@'</span>);
<a name="l00400"></a>00400   <a class="code" href="debug_8h.html#ca68c0d4ac8df0838e209fb5300f7be3" title="Assert if debugging is turned on.">ASSERT</a>(p);
<a name="l00401"></a>00401   <span class="keywordtype">size_t</span> ident_len = p - ident;
<a name="l00402"></a>00402   <span class="keywordtype">char</span> <span class="keyword">const</span>* real_hostname = p + 1;
<a name="l00403"></a>00403   <span class="keywordtype">size_t</span> real_hostname_len = prefix.end() - real_hostname;
<a name="l00404"></a>00404   <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#c82636dc236ae926a782ca602b800ff5" title="Set host name string as returned by real_hostname().">set_real_hostname</a>(std::string(real_hostname, real_hostname_len));
<a name="l00405"></a>00405   <a class="code" href="classIdentityReference.html#d6ecfc07c4dba821671a00c8ced70b04" title="Returns a const reference to the underlying identity.">identity</a>().<a class="code" href="classIdentity.html#07a9dbfdd574e3661874ac30e810f699" title="Set ident string as returned by ident().">set_ident</a>(std::string(ident, ident_len));
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="keywordtype">void</span> ServerConnection::quit(std::string <span class="keyword">const</span>&amp; msg)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410   <a class="code" href="classServerConnection.html#da968ead31fd07d9964f251530cc81d3" title="True if we should try to (re)connect.">M_reconnect</a> = <span class="keyword">false</span>;
<a name="l00411"></a>00411   <span class="keywordflow">if</span> (<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>)
<a name="l00412"></a>00412   {
<a name="l00413"></a>00413     *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a> &lt;&lt; <span class="stringliteral">"QUIT :"</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">"\r\n"</span>;
<a name="l00414"></a>00414     <span class="comment">// Force a disconnect if the server reacts too slow.</span>
<a name="l00415"></a>00415     timeval delay = { 1, 0 };
<a name="l00416"></a>00416     timerRequest(delay, *<a class="code" href="classServerConnection.html#54a242749c6d8c4f074d54cb034c7b66" title="A pointer to the current server session, or NULL when there is none.">M_server_session</a>, &amp;<a class="code" href="classServerSession.html#ef1ffc59c11f11e7e5aa743306a1ae03" title="Called 1 second after sending a QUIT and the connection still wasn&amp;#39;t terminated...">ServerSession::force_quit</a>);
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418 }
</pre></div></div>
<hr>

<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0>
<TR>
<TH ALIGN=left BGCOLOR="#e8feff"><ADDRESS>Copyright &copy; 2005-2007 Carlo Wood.&nbsp; All rights reserved.</ADDRESS></TH>
</TR>
</TABLE>

</DIV>
</BODY>
</HTML>

