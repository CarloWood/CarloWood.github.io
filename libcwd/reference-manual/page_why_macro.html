<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML LANG="en-us">
<HEAD>
<META name="Author" content="Carlo Wood">
<META name="description" content="C++ debugging support library with ostream debug output">
<META name="keywords" content="libcwd, debug output, debug facility, debug channel, object orientation, OO, C++, nested debug output, ostream, memory allocation, debugging, source file and line number">
<META http-equiv="content-type" content="text/html; charset=iso-8859-1">
<META http-equiv="content-script-type" content="text/javascript">
<TITLE>libcwd: The C++ Debugging Support Library - Reference Manual</TITLE>
<SCRIPT src="../scripts/detect_browser.js"></SCRIPT>
<SCRIPT>need_style_doxygen=1</SCRIPT>
<SCRIPT src="../scripts/load_style_sheets.js"></SCRIPT>
</HEAD>
<BODY>
<DIV class="normal">
<center>
<a class="qindex" href="../index.html">Main Page</a> &nbsp;
<a class="qindex" href="index.html">Reference Manual</a> &nbsp;
<a class="qindex" href="namespaces.html">Namespace List</a> &nbsp;
<a class="qindex" href="annotated.html">Compound List</a> &nbsp;
<a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp;
<a class="qindex" href="functions.html">Compound Members</a> &nbsp;
<a class="qindex" href="globals.html">File Members</a> &nbsp;
</center>
<HR SIZE=1 NOSHADE>
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Design Consideration Concerning Macros </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page describes why we use a macro instead of an inline function for <code><a class="el" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3" title="Macro for writing debug output.">Dout()</a></code>.</p>
<p>Good C++ code whenever possible, should not use macros but <code>inline</code> functions which have the advantage of type checking, overloading and easier debugging with a debugger.&#160; It is therefore a very relevant question to ask why a macro was used for <code><a class="el" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3" title="Macro for writing debug output.">Dout()</a></code>.</p>
<p>Using a macro has its advantages however:</p>
<ol>
<li>
It inlines the debug code even when we don't use optimization. </li>
<li>
It allows us to use tricks that make the code run faster when debug code is included. </li>
<li>
It allows us to omit variables in the program that are only used for debugging and which are written to a debug <code>ostream</code>. </li>
<li>
It compiles faster when debugging is omitted. </li>
<li>
No optimization is needed to really get rid of the debug code when debugging is omitted. </li>
</ol>
<p>Points 1, 2 and 3 are the most important reasons that lead to the decision to use a macro.&#160; Please note that the author of libcwd used the alternative for <b>two years</b> before finally deciding to <b>rewrite</b> the debug facility, being convinced that it was better to do it the way it is done now.&#160; While points 4 and 5 are trivial, the first three advantages might need some explanation:</p>
<ol type="1">
<li>Usually a developer won't use compiler optimization because that makes debugging harder.&#160; In most cases the debug code will be compiled and used <em>without</em> compiler optimization; implying the fact that no inlining is done.&#160; Moreover, we expect to use a lot of inserter operators and without optimization, each of these will be called.&#160; [ Note that when omitting debug code we can't get rid of the content of all <code>operator&lt;&lt;</code> functions because they might be used for non-debug code too, so we'd need to use a trick and write to something else than an <code>ostream</code> (let's say to a class <code>no_dstream</code>).&#160; Each call to <code>template&lt;class T&gt; no_dstream operator&lt;&lt;(T) { };</code> would actually be done(!), without inlining (point&#160;5&#160;above)&#160;].</li>
<li>Let's develop step by step an example where we write debug output.</li>
</ol>
<p>Let's start with writing some example debug output to <code>cerr</code>.</p>
<div class="fragment"><div class="line">std::cerr &lt;&lt; <span class="stringliteral">&quot;i = &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;; j = &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot;; s = &quot;</span> &lt;&lt; s &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>This line calls seven functions.&#160; If we want to save CPU time when we <b>don't</b> want to write this output, then we need to test whether the debugging output (for this specific channel) is turned on or off <b>before</b> calling the <code>operator&lt;&lt;()</code>'s.&#160; After all, such an operator call can use a lot of CPU time for arbitrary objects.</p>
<p>We cannot pass <code>"i = " &lt;&lt; i &lt;&lt; "; j = " &lt;&lt; j &lt;&lt; "; s = " &lt;&lt; s &lt;&lt; std::endl</code> to an inline function without causing all <code>operator&lt;&lt;</code> functions to be called.&#160; The only way, not using a macro, to achieve that no <code>operator&lt;&lt;</code> is called is by not calling them in the first place: We can't write to an <code>ostream</code>.&#160; It is necessary to write to a new class (let's call that class <code>dstream</code>) which checks if the debug channel we are writing to is turned on before calling the <code>ostream operator&lt;&lt;()</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</div>
<div class="line">  <span class="keyword">inline</span> dstream&amp;</div>
<div class="line">  <a class="code" href="group__group__overview.html#ga0e540104a5cc3e3b9c653a9f07c75160">operator&lt;&lt;</a>(dstream&amp; ds, T <span class="keyword">const</span>&amp; data)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (on)</div>
<div class="line">      std::cerr &lt;&lt; data;</div>
<div class="line">  }</div>
<div class="ttc" id="agroup__group__overview_html_ga0e540104a5cc3e3b9c653a9f07c75160"><div class="ttname"><a href="group__group__overview.html#ga0e540104a5cc3e3b9c653a9f07c75160">libcwd::operator&lt;&lt;</a></div><div class="ttdeci">std::ostream &amp; operator&lt;&lt;(std::ostream &amp;o, malloc_report_nt)</div><div class="ttdoc">Allow writing of enum malloc_report_nt to an ostream.</div><div class="ttdef"><b>Definition:</b> debugmalloc.cc:2961</div></div>
</div><!-- fragment --><p>Nevertheless, even with inlining (often requiring the highest level of optimization), most compilers would turn that into:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;i = &quot;</span>;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; i;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;; j = &quot;</span>;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; j;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;; s = &quot;</span>;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; s;</div>
<div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>checking <code>on</code> seven times.</p>
<p>With a macro we can easily achieve the best result, even without any optimization:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (on)</div>
<div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;i = &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;; j = &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot;; s = &quot;</span> &lt;&lt; s &lt;&lt; std::endl;</div>
</div><!-- fragment --><ol type="1">
<li>Sometimes a variable is specific to debug code and only being used for writing to a debug ostream.&#160; When the debug is omitted and inline functions are used for the <code><a class="el" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3" title="Macro for writing debug output.">Dout()</a></code> calls, then these variables still need to exist: they are passed to the <code><a class="el" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3" title="Macro for writing debug output.">Dout()</a></code> function (or actually, to the <code>no_dstream operator&lt;&lt;()</code>'s).&#160; Using a macro allows one to really get rid of such variables by surrounding them with <code>#ifdef CWDEBUG ... #endif</code> preprocessor directives.</li>
</ol>
<p>Example:</p>
<div class="fragment"><div class="line">  <span class="keywordflow">if</span> (need_close)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3">Dout</a>(<a class="code" href="group__group__default__dc.html#ga06f27a7560f652ec93e140b967ffbd58">dc::system</a>|<a class="code" href="group__group__control__flags.html#gga9d5fcf5636bf2a88e53860ccbe858d23a8527fca23ebd096406549034d9ff3b77">continued_cf</a>, <span class="stringliteral">&quot;close(&quot;</span> &lt;&lt; __fd &lt;&lt; <span class="stringliteral">&quot;) = &quot;</span>);</div>
<div class="line"><span class="preprocessor">#ifdef CWDEBUG</span></div>
<div class="line">    <span class="keywordtype">int</span> ret =</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    ::close(__fd);</div>
<div class="line">    <a class="code" href="debug_8h.html#a345365647bad2709dac5955a83d33aa3">Dout</a>(<a class="code" href="group__group__default__dc.html#ga33bc4b6cb3a23b09521bfa69e0da3e7c">dc::finish</a>|<a class="code" href="group__group__control__flags.html#ga527a161a4adf77a422aa562e7ed00fa8">cond_error_cf</a>(ret &lt; 0), ret);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="ttc" id="adebug_8h_html_a345365647bad2709dac5955a83d33aa3"><div class="ttname"><a href="debug_8h.html#a345365647bad2709dac5955a83d33aa3">Dout</a></div><div class="ttdeci">#define Dout(cntrl, data)</div><div class="ttdoc">Macro for writing debug output.</div><div class="ttdef"><b>Definition:</b> debug.h:154</div></div>
<div class="ttc" id="agroup__group__control__flags_html_ga527a161a4adf77a422aa562e7ed00fa8"><div class="ttname"><a href="group__group__control__flags.html#ga527a161a4adf77a422aa562e7ed00fa8">libcwd::cond_error_cf</a></div><div class="ttdeci">control_flag_t cond_error_cf(bool err)</div><div class="ttdoc">Returns error_cf when cond is true.</div><div class="ttdef"><b>Definition:</b> control_flag.h:86</div></div>
<div class="ttc" id="agroup__group__control__flags_html_gga9d5fcf5636bf2a88e53860ccbe858d23a8527fca23ebd096406549034d9ff3b77"><div class="ttname"><a href="group__group__control__flags.html#gga9d5fcf5636bf2a88e53860ccbe858d23a8527fca23ebd096406549034d9ff3b77">libcwd::continued_cf</a></div><div class="ttdeci">@ continued_cf</div><div class="ttdoc">Start a continued debug output.</div><div class="ttdef"><b>Definition:</b> control_flag.h:76</div></div>
<div class="ttc" id="agroup__group__default__dc_html_ga06f27a7560f652ec93e140b967ffbd58"><div class="ttname"><a href="group__group__default__dc.html#ga06f27a7560f652ec93e140b967ffbd58">libcwd::channels::dc::system</a></div><div class="ttdeci">channel_ct system</div><div class="ttdef"><b>Definition:</b> debug.cc:467</div></div>
<div class="ttc" id="agroup__group__default__dc_html_ga33bc4b6cb3a23b09521bfa69e0da3e7c"><div class="ttname"><a href="group__group__default__dc.html#ga33bc4b6cb3a23b09521bfa69e0da3e7c">libcwd::channels::dc::finish</a></div><div class="ttdeci">continued_channel_ct finish</div><div class="ttdef"><b>Definition:</b> debug.cc:517</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<ADDRESS>Copyright &copy; 2001 - 2004 Carlo Wood.&nbsp; All rights reserved.</ADDRESS>
</DIV>
</BODY>
</HTML>
