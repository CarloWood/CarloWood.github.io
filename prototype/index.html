<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML LANG="en">
<HEAD>
	<META name="Author" content="Carlo Wood">
	<META http-equiv="content-type" content="text/html; charset=iso-8859-1">
	<TITLE>Prototype Makefiles</TITLE>
</HEAD>

<BODY BGCOLOR="#c8ccc8">
<CENTER>
<IMG SRC="../images/prototype.jpg"><BR CLEAR=ALL>
</CENTER>

<H2>Postscript Warning</H2>

<p>I do not use prototype anymore; it is therefore not anymore maintained.
If something breaks (ie, due to compiler changes) then feel free to tell
me and I'll fix it. For my own projects I now use a project generator,
which generates a full-blown cwautomacros/cdeh/automake/autoconf/libtool/doxygen/etc
project; this is still work IN PROGRESS, but you can see a preview 
<a href="../howto/project/">here</a>. The generator itself is not online yet,
mail me if you're interested.</p>

<H2>Introduction</H2>

<P>Prototype Makefiles allows <B>very fast</B> project start ups:
often no editing of Makefiles is needed at ALL.</P>

<P>Prototype Makefiles is a collection of shared Makefiles which are
installed globally, and Makefile templates that can be copied into
project directories using a simple script.&nbsp; The shared Makefiles
contain the rules for building a project, cleaning it and making
dependencies etc.&nbsp; The Makefile templates contain the data that
is specific for each project.&nbsp; This separation avoids duplication
of code in Makefiles and is therefore extremely easy to maintain
and extend.</P>

<H2>Quick start</H2>

<H4>Installation</H4>

<OL TYPE=1>

<LI><P>Download the tar ball below.</P></LI>

<LI><P>Unpack it with:</P>
<PRE>
    tar xzf prototype-1.10.tar.gz
</PRE>
<P>This creates a subdirectory called <CODE>prototype-1.10</CODE> in the current directory.</P></LI>

<LI><P><CODE>cd</CODE> into <CODE>prototype-1.10</CODE>:</P>
<PRE>
    cd prototype-1.10
</PRE></LI>

<LI><P>Pick a directory where you want to install the shared stuff:</P>
<PRE>
    ./configure --prefix=/usr --datadir=/usr/share
</PRE>
<P>See the INSTALL file for the meaning of the options.</P>

<TABLE WIDTH=500 BORDER=0 BGCOLOR="#eeeeee" CELLPADDING=4>
  <TR><TD BGCOLOR=#eeeeff><CENTER><B>New</B> (as of version 1.8)</CENTER><TD></TR>
  <TR><TD><P>If you are <EM>upgrading</EM> <CODE>prototype</CODE> and you have already installed an older version, then you can just type:</P>
  <PRE>
    ./configure
  </PRE>
  <P>and it will determine the <I>prefix</I> and <I>datadir</I> that you used before.</P></TD></TR>
</TABLE><BR></LI>

<LI><P>Install the package:</P>
<PRE>
    make install
</PRE>
<P>(Or <CODE>&nbsp;gmake install&nbsp;</CODE> if you are using FreeBSD)</P></LI>

<LI><P>The <EM>environment</EM> variable <CODE>PROTODIR</CODE> should point to the <I>prototype</I> installation directory (<CODE><I>$(datadir)</I>/prototype</CODE>, where <CODE><I>$(datadir)</I></CODE> is set with <CODE>--datadir</CODE> while running <CODE>./configure</CODE>, see the INSTALL file).</P>
<P>As an example, if you use <CODE>bash</CODE> as your shell, you could add to your <CODE>~/.profile</CODE> the following line,</P>
<PRE>
    export PROTODIR=/usr/share/prototype
</PRE></LI>

<LI><P>Edit <CODE>$PROTODIR/Makedefs.h</CODE> to set your own prefered default values for
<CODE>CFLAGS</CODE> and <CODE>CXXFLAGS</CODE>.&nbsp; Please note that this file is overwritten
the next time you upgrade (I'll fix that some day).</P></LI>

<LI><P>To test the successful installation (all of the above), run the command:</P>
<PRE>
    make test
</PRE></LI>
</OL>

<H4>Usage</H4>

<P>Now you are ready to use the <CODE>prototype</CODE> Makefiles.<P>

<OL TYPE=1>
<LI><P>Create a new project directory and change directory into it:</P>
<PRE>
    mkdir myProject
    cd myProject
</PRE></LI>

<LI><P>Generate the <EM>base</EM> (project) Makefile:</P>
<PRE>
    makeproto
</PRE>
<P>Note that you can not put sources in this directory, it wouldn't belong to anything.<BR>
Instead create a `main', `lib' or `sub' directory. For instance:</P></LI>
<LI><P>Create a directory and Makefile for the (or a) main executable:</P>
<PRE>
    mkdir aProgram
    cd aProgram
    makeproto main
</PRE>
</P></LI>

<LI><P>Write code and just type <CODE>make</CODE> when you want to compile it!</P>
</OL>

<P>Please, also read the README file that comes with the package.</P>

<H3>Example</H3>

<P>Below is given a Real Life (tm) project Makefile for a large and complex
shared library which is divided up over several sub directories
(the Makefiles in each of these subdirectories are not given, but look
similar - with only data specific for that directory).
This file is everything that needs maintenance for this sub directory.
Everything that was added manually is made <B>bold</B>, the rest was
generated by typing `<CODE>makeproto lib</CODE>':</P>

<PRE>
  # Directory where the base Makefile resides:
  BASEDIR=../..

  # Library name, for example: "LIB=foo" -> libfoo.so and libfoo.a
  # The version of the library is read from .$(LIB).version (which is
  # automatically incremented 1 Minor Version every time you (re)install.
  LIB=<B>cw</B>

  # List of subdirectories:
  SUBDIRS:=$(shell list=`/bin/ls -1 -t | egrep -v '^(CVS<B>|include</B>)$$'`; for i in $$list; do if test -d $$i; then echo $$i; fi; done)

  # List of source files:
  CXXSRC:=$(shell /bin/ls -1 -t -F *$(CPPEXT) 2>/dev/null | grep '\$(CPPEXT)$$')

  # Library specific include flags, for example: -I$(BASEDIR)/include or -I.
  INCLUDEFLAGS=

  # Extra static libraries to link with:
  STATICLIBS=

  # Extra shared libraries to link with:
  SHAREDLIBS=<B>-lcwd</B>

  # Put here extra -L... flags
  LIBFLAGS=

  #-----------------------------------------------------------------------------

  include $(PROTODIR)/lib/PTMakefile

  #clean::
  #depend::
  #build::

  <B>version.cc: Makefile .cw.version
	  echo "char const* libcw_version = \"$(VERSION)\";" > version.cc

  real-clean::
	  $(RM) -f version.cc

  include .cw.version

  CW_MAJOR:=$(VERSION_MAJOR)
  CW_MINOR:=$(VERSION_MINOR)
  CW_PATCH:=$(VERSION_PATCH)
  CW_VERSION:=$(VERSION_MAJOR).$(VERSION_MINOR).$(VERSION_PATCH)

  install:
	  @( if [ -f $(BASEDIR)/lib/libcw.so.$(CW_VERSION) ]; then \
	    make .cw.install.timestamp; \
	  else \
	    echo "libcw.so.$(CW_VERSION) wasn't compiled yet"; \
	  fi )

  .cw.install.timestamp: $(BASEDIR)/lib/libcw.so.$(CW_VERSION)
	  $(INSTALL) -g $(INSTALL_GROUP) -m 755 -o $(INSTALL_OWNER) $(BASEDIR)/lib/libcw.so.$(CW_VERSION) $(LIB_DIR)
	  touch .cw.install.timestamp
	  /sbin/ldconfig
	  ln -sf $(LIB_DIR)/libcw.so.$(CW_MAJOR) $(LIB_DIR)/libcw.so
	  $(INSTALL) -d $(PREFIX)/include/libcw
	  $(INSTALL) -g $(INSTALL_GROUP) -m 644 -o $(INSTALL_OWNER) include/libcw/*.h $(PREFIX)/include/libcw
	  @echo "VERSION_MAJOR=$(CW_MAJOR)" > .cw.version
	  @echo "VERSION_MINOR=$(CW_MINOR)" >> .cw.version
	@echo "$(CW_PATCH)" | awk -- '{ printf ("VERSION_PATCH=%d\n", $$0 + 1) }' >> .cw.version</B>
</PRE>

<H2>Changes in version 1.10</H2>

<UL>
<LI><P>The use of the gcc commandline option <CODE>-I-</CODE> had been
deprecated for a while now. I just removed it from the PTMakefile's.</P></LI>
<LI><P>The test (make test) was fixed to work with modern C++ compilers
that demand that std::cout is used instead of just cout.</P></LI>
</UL>

<H2>Changes in version 1.9</H2>

<UL>
<LI><P>Fixed the default <CODE>Makedefs.h</CODE>: the given example cause
<CODE>CPPEXT</CODE> to end on a space which then resulted in a total
failure of everything else (It must be: <CODE>CPPEXT=.cc</CODE> on it own
on a line, <B>not</B> <CODE>CPPEXT=".cc"</CODE> with or without a comment
behind it).</P></LI>
<LI><P>The test (make test) was fixed to work around a bug in the
libstdc++ that comes with for instance RedHat-7.0
(<CODE>_G_CLOG_CONFLICT</CODE> needs to be defined).</P></LI>
</UL>

<H2>Changes in version 1.8</H2>

<UL>
<LI><P>Support for FreeBSD: The path to <CODE>make</CODE> is now better
propagated so things work when you are using <CODE>gmake</CODE> for
instance.&nbsp; FreeBSDs <CODE>find</CODE> does not support
<CODE>-mindepth</CODE> <CODE>-maxdepth</CODE> or <CODE>-printf</CODE>,
therefore <CODE>find</CODE> has been replaced with a construction
using <CODE>ls</CODE> and <CODE>grep</CODE>.&nbsp;
All UNIX programs that used to be set in <CODE>$PROTODIR/Makedefs.h</CODE>
are now determined, including path, by <CODE>./configure</CODE>.&nbsp;
During installation <CODE>/bin/sh</CODE> is used (<CODE>bash</CODE> is
still needed to use prototype makefiles).</P></LI>
<LI><P><CODE>./configure</CODE> now tries to extract <CODE>--prefix</CODE>
and <CODE>--datadir</CODE> automatically from a previous install.</P></LI>
</UL>

<H2>Changes in version 1.7</H2>

<UL>
<LI><P>Fixed all Makefiles with a loop like
&quot;<CODE>for&nbsp;i&nbsp;in&nbsp;$(SUBDIRS);&nbsp;do</CODE>&quot;.
The behaviour of <CODE>for</CODE> in bash-2 changed from bash-1.14
and prototype would not work with bash-2.</P></LI>
</UL>

<H2>Changes in version 1.6</H2>

<UL>
<LI><P>Only remove ELF executable files, not scripts, in target
<CODE>real-clean</CODE>.</P></LI>
<LI><P>Added CPPEXT to <TT>$PROTODIR/Makedefs.h</TT>.</P></LI>
</UL>

<H2>Changes in version 1.5</H2>

<UL>
<LI><P>Bug fixes for target <CODE>real-clean</CODE>: <CODE>.cvsignore</CODE>
files were wrongly deleted and recursion into sub directories was broken.</P></LI>
<LI><P>Target <I>shared</I> didn't create the <TT>$BASEDIR/lib</TT> directory,
if it doesn't exist, before copying the shared library there.</P></LI>
</UL>

<H2>Changes in version 1.4</H2>

<UL>
<LI><P>A few minor bug fixes:</P></LI>
<LI><P>typing <CODE>make</CODE> in a subdirectory
caused the target <CODE>.depend</CODE> to be build while checking the
<CODE>Makefile</CODE> target.&nbsp;
This can fail since <CODE>INCLUDEFLAGS</CODE> is set by the
Makefile(s) in the parent directories now.</P></LI>
<LI><P>Also, it was possible that the dependency on subdirectory objects
caused these object files to be rebuild with the rules of the parent
Makefile. Both bugs have been fixed.</P></LI>
</UL>

<H2>Changes in version 1.3</H2>

<UL>
<LI><P>The <CODE>INCLUDEFLAGS</CODE> variable is now correctly
propagated to sub directories by replacing each occurance of
&quot;<CODE>-I</CODE>&quot; by &quot;<CODE>-I../</CODE>&quot;.</P></LI>
</UL>

<H2>Changes in version 1.2</H2>

<UL>
<LI><P><CODE>$PROTODIR/Makedefs.h</CODE> was corrected to include a
<CODE>DFLAGS</CODE> variable which can be set to <CODE>-MM</CODE> or
<CODE>-M</CODE> to produce respectively dependencies of only local
header files (between double quotes) or also system header files
(between angle brackets)</P>

<P>Of course you can change the default per project in your
<CODE>$BASEDIR/Makedefs.h</CODE> file.</P></LI>
</UL>

<H2>Changes in version 1.1</H2>

<UL>
<LI><P>If you upgrade from version 1.0, then please note that
you will have to set a new environment variable (<CODE>CPPEXT</CODE>)
and that the variable SRC has been spliced into two:
<CODE>CSRC</CODE> and <CODE>CXXSRC</CODE>, for C sources and
C++ sources respectively.&nbsp;
You will have to edit all your projects Makefiles and change
<CODE>SRC</CODE> into <CODE>CXXSRC</CODE> (assuming it's a
C++ project), sorry about that.&nbsp;
Also, <CODE>CFLAGS</CODE> is now only used for C sources,
you'll have to change <CODE>CXXFLAGS</CODE> for C++ projects.</P></LI>
</UL>

<P><B>Warning:</B> Upgrading prototype will overwrite
<CODE>$PROTODIR/Makedefs.h</CODE>. If you made changes to that file
(most likely setting a different default <CODE>CFLAGS</CODE>), then you'll
have to redo that by hand after installing. You might
want to backup <CODE>$PROTODIR/Makedefs.h</CODE> before installing.</P>

<H2>Downloading</H2>

<LI><A HREF="prototype-1.10.tar.gz">prototype-1.10.tar.gz</A>

</BODY>
</HTML>
